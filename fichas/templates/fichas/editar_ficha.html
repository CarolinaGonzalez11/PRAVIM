{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block content %}

<style>
body {
    font-family: Arial, sans-serif;
    background-color: #f4f6f8;
    margin: 0;
    padding: 0;
}
.form-container {
    max-width: 100%;
    margin: 0 auto;
    background-color: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    overflow-x: auto;
}
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}
th {
    background-color: #252c54 ;
    color: white;
    font-size: 14px;
    padding: 8px;
    text-align: left;
}
td.label-cell {
    background-color: #252c54 ;
    color: white;
    width: 25%;
    font-weight: bold;
    padding: 8px;
    vertical-align: top;
}
td.input-cell {
    width: 75%;
    padding: 8px;
    vertical-align: top;
}
input[type="text"],
input[type="date"],
select, textarea {
    width: 100%;
    padding: 6px;
    font-size: 14px;
    border: 1px solid #ccc;
    border-radius: 4px;
}
.btn-institucional {
    background-color: #252c54;
    color: #fff;
    border: none;
    padding: 12px 32px;
    border-radius: 6px;
    font-size: 1.1rem;
    font-weight: bold;
    box-shadow: 0 2px 8px rgba(37, 44, 84, 0.15);
    margin-top: 12px;
}
.btn-institucional:hover, .btn-institucional:focus {
    background-color: #1a2040;
    color: #fff;
}
.btn-descartar {
    background-color: #ddd;
    color: #252c54;
    border: none;
    padding: 10px 28px;
    border-radius: 6px;
    font-weight: bold;
}
.btn-descartar:hover, .btn-descartar:focus {
    background-color: #bbb;
    color: #252c54;
}
@media (max-width: 768px) {
    table, thead, tbody, th, td, tr {
        display: block;
        width: 100%;
    }
    th, td {
        border: 1px solid white;
    }
}
textarea {
    min-height: 40px;
    max-height: 500px;
    overflow-y: hidden;
    resize: vertical;
    padding: 6px;
    font-size: 14px;
    width: 100%;
    box-sizing: border-box;
}
.form-footer {
    margin-bottom: 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.accordion-button { background-color: #252c54 ; color: white; }
.accordion-button:not(.collapsed) { background-color: #e60380 ; color: white; }
.accordion-button:focus { box-shadow: none; outline: none; }
.label-cell { background-color: #252c54 ; color: white; width: 25%; font-weight: bold; padding: 8px; vertical-align: top; }
.input-cell { width: 75%; padding: 8px; vertical-align: top; }
</style>

<div class="container mt-4">
    <h2 class="mb-4" style="color:#252c54;font-weight:700;">
        Editar Ficha de Acogida N° {{ ficha.id }}
    </h2>
    <form method="post" id="formFicha" autocomplete="off">
        {% csrf_token %}

        <div class="accordion" id="formAccordion">
            <!-- Acordeón 1: Preingreso + Individualización + Denuncia -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingPreingreso">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePreingreso">
                        Preingreso e Individualización
                    </button>
                </h2>
                <div id="collapsePreingreso" class="accordion-collapse collapse show" data-bs-parent="#formAccordion">
                    <div class="accordion-body">
                        <!-- PREINGRESO -->
                        <h4 class="mb-3">Módulo 1A: Preingreso</h4>
                        <div class="table-responsive-preingreso">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Fecha recepción</th>
                                        <th>Vía de ingreso</th>
                                        <th>Fecha contacto 1</th>
                                        <th>Fecha contacto 2</th>
                                        <th>Fecha contacto 3</th>
                                        <th>Tipo de contacto</th>
                                        <th>¿Ingreso efectivo?</th>
                                        <th>Fecha de ingreso</th>
                                        <th>Profesionales primer contacto</th>
                                        <th>¿Recibió contención inicial?</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>{{ form_ficha.fecha_recepcion|add_class:"editable-field" }}</td>
                                        <td>{{ form_ficha.via_ingreso|add_class:"editable-field" }}</td>
                                        <td>{{ form_ficha.fecha_contacto_1|add_class:"editable-field" }}</td>
                                        <td>{{ form_ficha.fecha_contacto_2|add_class:"editable-field" }}</td>
                                        <td>{{ form_ficha.fecha_contacto_3|add_class:"editable-field" }}</td>
                                        <td>{{ form_ficha.tipo_contacto|add_class:"editable-field" }}</td>
                                        <td>{{ form_ficha.ingreso_efectivo|add_class:"editable-field" }}</td>
                                        <td>{{ form_ficha.fecha_ingreso|add_class:"editable-field" }}</td>
                                        <td>{{ form_ficha.profesionales_contacto_1|add_class:"editable-field" }}</td>
                                        <td>{{ form_ficha.contencion_inicial|add_class:"editable-field" }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- PERSONA ATENDIDA -->
                        <h4 class="mt-5 mb-3">Módulo 1B: Datos de la Persona Atendida</h4>
                        <table>
                            <tbody>
                                <tr><td class="label-cell">Nombre</td><td class="input-cell">{{ form_persona.nombre|add_class:"editable-field" }}</td></tr>
                                <tr><td class="label-cell">RUT / Nº Pasaporte</td><td class="input-cell">{{ form_persona.rut_pasaporte|add_class:"editable-field" }}</td></tr>
                                <tr><td class="label-cell">Género</td><td class="input-cell">{{ form_persona.genero|add_class:"editable-field" }}</td></tr>
                                <tr><td class="label-cell">Teléfono</td><td class="input-cell">{{ form_persona.telefono|add_class:"editable-field" }}</td></tr>
                                <tr><td class="label-cell">Fecha de Nacimiento</td><td class="input-cell">{{ form_persona.fecha_nacimiento|add_class:"editable-field" }}</td></tr>
                                <tr><td class="label-cell">País de Nacionalidad</td><td class="input-cell">{{ form_persona.nacionalidad|add_class:"editable-field" }}</td></tr>
                                <tr><td class="label-cell">Estado Civil</td><td class="input-cell">{{ form_persona.estado_civil|add_class:"editable-field" }}</td></tr>
                                <tr><td class="label-cell">Previsión</td><td class="input-cell">{{ form_persona.prevision|add_class:"editable-field" }}</td></tr>
                                <tr><td class="label-cell">CESFAM Vinculante</td><td class="input-cell">{{ form_persona.cesfam|add_class:"editable-field" }}</td></tr>
                                <tr><td class="label-cell">Ocupación</td><td class="input-cell">{{ form_persona.ocupacion|add_class:"editable-field" }}</td></tr>
                                <tr><td class="label-cell">Dirección</td><td class="input-cell">{{ form_persona.direccion|add_class:"editable-field" }}</td></tr>
                                <tr><td class="label-cell">Villa</td><td class="input-cell">{{ form_persona.villa|add_class:"editable-field" }}</td></tr>
                                <tr><td class="label-cell">Barrio</td><td class="input-cell">{{ form_persona.barrio|add_class:"editable-field" }}</td></tr>
                                <tr><td class="label-cell">Cuadrante</td><td class="input-cell">{{ form_persona.cuadrante|add_class:"editable-field" }}</td></tr>
                                <tr><td class="label-cell">¿Situación de Discapacidad?</td><td class="input-cell">{{ form_persona.discapacidad|add_class:"editable-field" }}</td></tr>
                                <tr><td class="label-cell">¿Pertenencia a pueblo originario / etnia?</td><td class="input-cell">{{ form_persona.etnia|add_class:"editable-field" }}</td></tr>
                                <tr><td class="label-cell">¿Diversidad (sexo/género/orientación)?</td><td class="input-cell">{{ form_persona.diversidad|add_class:"editable-field" }}</td></tr>
                                <tr><td class="label-cell">Nombre de persona significativa</td><td class="input-cell">{{ form_persona.persona_significativa|add_class:"editable-field" }}</td></tr>
                                <tr><td class="label-cell">Vínculo con persona significativa</td><td class="input-cell">{{ form_persona.vinculo|add_class:"editable-field" }}</td></tr>
                                <tr><td class="label-cell">Teléfono significativo</td><td class="input-cell">{{ form_persona.telefono_significativo|add_class:"editable-field" }}</td></tr>
                                <tr><td class="label-cell">N° adultos hogar</td><td class="input-cell">{{ form_persona.n_adultos|add_class:"editable-field" }}</td></tr>
                                <tr><td class="label-cell">N° NNA hogar</td><td class="input-cell">{{ form_persona.n_nna|add_class:"editable-field" }}</td></tr>
                            </tbody>
                        </table>

                        <!-- DENUNCIA -->
                        <h4 class="mt-5 mb-3">Módulo 1C: Denuncia</h4>
                        <table>
                            <tbody>
                                <tr>
                                    <td class="label-cell">¿Tiene denuncia?</td>
                                    <td class="input-cell">{{ form_denuncia.tiene_denuncia|add_class:"editable-field" }}</td>
                                </tr>
                                <tr>
                                    <td class="label-cell">Dificultades en la denuncia</td>
                                    <td class="input-cell">
                                        {{ form_denuncia.dificultades|add_class:"editable-field" }}
                                        <div id="dificultades-otra-campo" style="display:none;">
                                            {{ form_denuncia.dificultades_otra|add_class:"editable-field" }}
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                            <tbody id="denuncia-detalle-campos" style="display: none;">
                                <tr>
                                    <td class="label-cell">Año de la denuncia</td>
                                    <td class="input-cell">{{ form_denuncia.anio_denuncia|add_class:"editable-field" }}</td>
                                </tr>
                                <tr>
                                    <td class="label-cell">Lugar de denuncia</td>
                                    <td class="input-cell">
                                        {{ form_denuncia.lugar_denuncia|add_class:"editable-field" }}
                                        <div id="otro-lugar-campo" style="display:none;">
                                            {{ form_denuncia.lugar_denuncia_otro|add_class:"editable-field" }}
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="label-cell">Número de causa</td>
                                    <td class="input-cell">{{ form_denuncia.numero_causa|add_class:"editable-field" }}</td>
                                </tr>
                                <tr>
                                    <td class="label-cell">Motivo denuncia</td>
                                    <td class="input-cell">{{ form_denuncia.motivo_denuncia|add_class:"editable-field" }}</td>
                                </tr>
                                <tr>
                                    <td class="label-cell">¿Medida cautelar?</td>
                                    <td class="input-cell">
                                        {{ form_denuncia.medida_cautelar|add_class:"editable-field" }}
                                        <div id="medida-cautelar-detalle-campo" style="display:none;">
                                            {{ form_denuncia.medida_cautelar_detalle|add_class:"editable-field" }}
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Acordeón 2: Motivo -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingMotivo">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMotivo">
                        Motivo de Ingreso
                    </button>
                </h2>
                <div id="collapseMotivo" class="accordion-collapse collapse" data-bs-parent="#formAccordion">
                    <div class="accordion-body">
                        <table>
                            <tbody>
                                <tr>
                                    <td class="label-cell">Motivo principal</td>
                                    <td class="input-cell">{{ form_motivo.motivo_ingreso|add_class:"editable-field" }}</td>
                                </tr>
                                <tr>
                                    <td class="label-cell">Descripción del caso</td>
                                    <td class="input-cell">{{ form_motivo.descripcion_motivo|add_class:"editable-field" }}</td>
                                </tr>
                                <tr id="motivo-otro-row" style="display:none;">
                                    <td class="label-cell">Si seleccionó Otro, especifique</td>
                                    <td class="input-cell">
                                        {{ form_motivo.motivo_otro|add_class:"editable-field" }}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Acordeón 3: Aspectos Psicológicos y Salud Mental -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingPsico">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePsico">
                        Aspectos Psicológicos y Salud Mental
                    </button>
                </h2>
                <div id="collapsePsico" class="accordion-collapse collapse" data-bs-parent="#formAccordion">
                    <div class="accordion-body">
                        <table>
                            <tbody>
                                <tr>
                                    <td class="label-cell">Antecedentes</td>
                                    <td class="input-cell">{{ form_psicologico.antecedentes|add_class:"editable-field" }}</td>
                                </tr>
                                <tr>
                                    <td class="label-cell">Diagnóstico</td>
                                    <td class="input-cell">{{ form_psicologico.diagnostico|add_class:"editable-field" }}</td>
                                </tr>
                                <tr id="diagnostico-otro-row" style="display:none;">
                                    <td class="label-cell">Otro diagnóstico (especifique)</td>
                                    <td class="input-cell">{{ form_psicologico.diagnostico_otro|add_class:"editable-field" }}</td>
                                </tr>
                                <tr>
                                    <td class="label-cell">¿Ha tenido atención en salud mental?</td>
                                    <td class="input-cell">{{ form_psicologico.atencion_salud_mental|add_class:"editable-field" }}</td>
                                </tr>
                                <tr id="atencion-anio-row" style="display:none;">
                                    <td class="label-cell">Año de atención</td>
                                    <td class="input-cell">{{ form_psicologico.atencion_anio|add_class:"editable-field" }}</td>
                                </tr>
                                <tr id="atencion-lugar-row" style="display:none;">
                                    <td class="label-cell">Lugar de atención</td>
                                    <td class="input-cell">{{ form_psicologico.atencion_lugar|add_class:"editable-field" }}</td>
                                </tr>
                                <tr>
                                    <td class="label-cell">¿Ha tenido internaciones?</td>
                                    <td class="input-cell">{{ form_psicologico.internacion|add_class:"editable-field" }}</td>
                                </tr>
                                <tr id="internacion-anio-row" style="display:none;">
                                    <td class="label-cell">Año de internación</td>
                                    <td class="input-cell">{{ form_psicologico.internacion_anio|add_class:"editable-field" }}</td>
                                </tr>
                                <tr id="internacion-lugar-row" style="display:none;">
                                    <td class="label-cell">Lugar de internación</td>
                                    <td class="input-cell">{{ form_psicologico.internacion_lugar|add_class:"editable-field" }}</td>
                                </tr>
                                <tr>
                                    <td class="label-cell">Ideación y/o intentos suicidas</td>
                                    <td class="input-cell">{{ form_psicologico.afectacion_psicologica|add_class:"editable-field" }}</td>
                                </tr>
                                <!-- Multiselección -->
                                <tr><td class="label-cell">Estado de conciencia</td><td class="input-cell">{{ form_psicologico.estado_conciencia|add_class:"editable-field" }}</td></tr>
                                <tr><td class="label-cell">Orientación</td><td class="input-cell">{{ form_psicologico.orientacion|add_class:"editable-field" }}</td></tr>
                                <tr><td class="label-cell">Estado cognitivo</td><td class="input-cell">{{ form_psicologico.estado_cognitivo|add_class:"editable-field" }}</td></tr>
                                <tr><td class="label-cell">Actitud</td><td class="input-cell">{{ form_psicologico.actitud|add_class:"editable-field" }}</td></tr>
                                <tr><td class="label-cell">Lenguaje</td><td class="input-cell">{{ form_psicologico.lenguaje|add_class:"editable-field" }}</td></tr>
                                <tr><td class="label-cell">Afectividad</td><td class="input-cell">{{ form_psicologico.afectividad|add_class:"editable-field" }}</td></tr>
                                <tr><td class="label-cell">Sueño</td><td class="input-cell">{{ form_psicologico.sueno|add_class:"editable-field" }}</td></tr>
                                <tr><td class="label-cell">Alimentación</td><td class="input-cell">{{ form_psicologico.alimentacion|add_class:"editable-field" }}</td></tr>
                                <tr><td class="label-cell">Limitación vida cotidiana</td><td class="input-cell">{{ form_psicologico.limitacion_vida_cotidiana|add_class:"editable-field" }}</td></tr>
                                <tr><td class="label-cell">¿Quiebre en historia de vida?</td><td class="input-cell">{{ form_psicologico.quiebre_historia_vida|add_class:"editable-field" }}</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Acordeón 4: Redes de Apoyo -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingRedes">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseRedes">
                        Redes de Apoyo
                    </button>
                </h2>
                <div id="collapseRedes" class="accordion-collapse collapse" data-bs-parent="#formAccordion">
                    <div class="accordion-body">
                        <table>
                            <tbody>
                                <tr><td class="label-cell">Red familiares</td><td class="input-cell">{{ form_redes.red_familiares|add_class:"editable-field" }}</td></tr>
                                <tr><td class="label-cell">Red amistades</td><td class="input-cell">{{ form_redes.red_amistades|add_class:"editable-field" }}</td></tr>
                                <tr><td class="label-cell">Red cónyuge</td><td class="input-cell">{{ form_redes.red_conyuge|add_class:"editable-field" }}</td></tr>
                                <tr><td class="label-cell">Red laborales</td><td class="input-cell">{{ form_redes.red_laborales|add_class:"editable-field" }}</td></tr>
                                <tr><td class="label-cell">Red otros personales</td><td class="input-cell">{{ form_redes.red_otros_personales|add_class:"editable-field" }}</td></tr>
                                <tr><td class="label-cell">Red junta de vecinos</td><td class="input-cell">{{ form_redes.red_junta_vecinos|add_class:"editable-field" }}</td></tr>
                                <tr><td class="label-cell">Red centro de madres</td><td class="input-cell">{{ form_redes.red_centro_madres|add_class:"editable-field" }}</td></tr>
                                <tr><td class="label-cell">Red club de adultos mayores</td><td class="input-cell">{{ form_redes.red_club_adultos|add_class:"editable-field" }}</td></tr>
                                <tr><td class="label-cell">Red club deportivo</td><td class="input-cell">{{ form_redes.red_club_deportivo|add_class:"editable-field" }}</td></tr>
                                <tr><td class="label-cell">Red otros comunitarios</td><td class="input-cell">{{ form_redes.red_otros_comunitarios|add_class:"editable-field" }}</td></tr>
                                <tr><td class="label-cell">Red Municipalidad</td><td class="input-cell">{{ form_redes.red_municipalidad|add_class:"editable-field" }}</td></tr>
                                <tr><td class="label-cell">Red CESFAM</td><td class="input-cell">{{ form_redes.red_cesfam|add_class:"editable-field" }}</td></tr>
                                <tr><td class="label-cell">Red establecimiento educativo</td><td class="input-cell">{{ form_redes.red_establecimiento|add_class:"editable-field" }}</td></tr>
                                <tr><td class="label-cell">Red ONG</td><td class="input-cell">{{ form_redes.red_ong|add_class:"editable-field" }}</td></tr>
                                <tr><td class="label-cell">Red COSAM</td><td class="input-cell">{{ form_redes.red_cosam|add_class:"editable-field" }}</td></tr>
                                <tr><td class="label-cell">Otra</td><td class="input-cell">{{ form_redes.red_otro_salud|add_class:"editable-field" }}</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Acordeón 5: Plan de Acción -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingPlan">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePlan">
                        Plan de Acción
                    </button>
                </h2>
                <div id="collapsePlan" class="accordion-collapse collapse" data-bs-parent="#formAccordion">
                    <div class="accordion-body">
                        <table>
                            <tbody>
                                <!-- UAV Atención Psicológica -->
                                <tr>
                                    <td class="label-cell" rowspan="3"><strong>UAV Atención Psicológica</strong></td>
                                    <td class="input-cell">
                                        <div class="checkbox-textarea-row">
                                            {{ form_plan.uav_psicologica_1|add_class:"editable-field" }} {{ form_plan.uav_psicologica_1_detalle|add_class:"editable-field" }}
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="input-cell">
                                        <div class="checkbox-textarea-row">
                                            {{ form_plan.uav_psicologica_2|add_class:"editable-field" }} {{ form_plan.uav_psicologica_2_detalle|add_class:"editable-field" }}
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="input-cell">
                                        <div class="checkbox-textarea-row">
                                            {{ form_plan.uav_psicologica_3|add_class:"editable-field" }} {{ form_plan.uav_psicologica_3_detalle|add_class:"editable-field" }}
                                        </div>
                                    </td>
                                </tr>
                                <!-- UAV Atención Social -->
                                <tr>
                                    <td class="label-cell" rowspan="3"><strong>UAV Atención Social</strong></td>
                                    <td class="input-cell">
                                        <div class="checkbox-textarea-row">
                                            {{ form_plan.uav_social_1|add_class:"editable-field" }} {{ form_plan.uav_social_1_detalle|add_class:"editable-field" }}
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="input-cell">
                                        <div class="checkbox-textarea-row">
                                            {{ form_plan.uav_social_2|add_class:"editable-field" }} {{ form_plan.uav_social_2_detalle|add_class:"editable-field" }}
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="input-cell">
                                        <div class="checkbox-textarea-row">
                                            {{ form_plan.uav_social_3|add_class:"editable-field" }} {{ form_plan.uav_social_3_detalle|add_class:"editable-field" }}
                                        </div>
                                    </td>
                                </tr>
                                <!-- UAV Atención Legal -->
                                <tr>
                                    <td class="label-cell" rowspan="3"><strong>UAV Atención Legal</strong></td>
                                    <td class="input-cell">
                                        <div class="checkbox-textarea-row">
                                            {{ form_plan.uav_legal_1|add_class:"editable-field" }} {{ form_plan.uav_legal_1_detalle|add_class:"editable-field" }}
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="input-cell">
                                        <div class="checkbox-textarea-row">
                                            {{ form_plan.uav_legal_2|add_class:"editable-field" }} {{ form_plan.uav_legal_2_detalle|add_class:"editable-field" }}
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="input-cell">
                                        <div class="checkbox-textarea-row">
                                            {{ form_plan.uav_legal_3|add_class:"editable-field" }} {{ form_plan.uav_legal_3_detalle|add_class:"editable-field" }}
                                        </div>
                                    </td>
                                </tr>
                                <!-- Patrullaje Preventivo -->
                                <tr>
                                    <td class="label-cell"><strong>Patrullaje preventivo</strong></td>
                                    <td class="input-cell">
                                        {{ form_plan.patrullaje_activo|add_class:"editable-field" }} Activar patrullaje preventivo
                                    </td>
                                </tr>
                                <tr>
                                    <td class="label-cell"></td>
                                    <td class="input-cell">
                                        {{ form_plan.patrullaje_turno_1|add_class:"editable-field" }} 1° Turno (07:00 a 15:00 hrs) /
                                        {{ form_plan.patrullaje_entrevista_1|add_class:"editable-field" }} Entrevista
                                    </td>
                                </tr>
                                <tr>
                                    <td class="label-cell"></td>
                                    <td class="input-cell">
                                        {{ form_plan.patrullaje_turno_2|add_class:"editable-field" }} 2° Turno (15:00 a 23:00 hrs) /
                                        {{ form_plan.patrullaje_entrevista_2|add_class:"editable-field" }} Entrevista
                                    </td>
                                </tr>
                                <tr>
                                    <td class="label-cell"></td>
                                    <td class="input-cell">
                                        {{ form_plan.patrullaje_turno_3|add_class:"editable-field" }} 3° Turno (23:00 a 07:00 hrs) /
                                        {{ form_plan.patrullaje_entrevista_3|add_class:"editable-field" }} Entrevista
                                    </td>
                                </tr>
                                <tr>
                                    <td class="label-cell"></td>
                                    <td class="input-cell">
                                        <label for="id_registro_patrullaje">N° de registro patrullaje</label>
                                        {{ form_plan.registro_patrullaje|add_class:"editable-field" }}
                                        <small class="form-text text-muted">Ejemplo: 2025-0001</small>
                                    </td>
                                </tr>
                                <!-- Profesional a cargo -->
                                <tr>
                                    <td class="label-cell"><strong>Profesional a cargo</strong></td>
                                    <td class="input-cell">
                                        {{ form_plan.profesional_nathaly|add_class:"editable-field" }} Nathaly Reyes<br>
                                        {{ form_plan.profesional_paloma|add_class:"editable-field" }} Paloma Quinteros<br>
                                        {{ form_plan.cordinadora_gloria|add_class:"editable-field" }} Gloria Rivera<br>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>


            <!-- Acordeón 6: Derivaciones -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingDerivaciones">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDerivaciones">
                        Derivaciones
                    </button>
                </h2>
                <div id="collapseDerivaciones" class="accordion-collapse collapse" data-bs-parent="#formAccordion">
                    <div class="accordion-body">

                        <table>
                            <tbody>
                                <!-- CAVD -->
                                <tr>
                                    <td class="label-cell">
                                        <input type="checkbox"
                                            name="deriv_cavd-check"
                                            id="deriv_cavd_chk"
                                            {% if form_deriv_cavd.initial.descripcion_cavd or form_deriv_cavd.initial.fecha_derivacion_cavd or form_deriv_cavd.initial.es_vinculacion_cavd or form_deriv_cavd.initial.fecha_respuesta_cavd or form_deriv_cavd.initial.ingresa_cavd or form_deriv_cavd.initial.fecha_ingreso_cavd or form_deriv_cavd.initial.es_conmocion_publica_cavd or form_deriv_cavd.initial.fecha_vinculacion_conmocion_cavd %}checked{% endif %}
                                            onchange="document.getElementById('deriv_cavd_fields').style.display = this.checked ? '' : 'none';">
                                        Programa Atención a Víctimas (CAVD)
                                    </td>
                                    <td class="input-cell">
                                        <table id="deriv_cavd_fields" style="display:{% if form_deriv_cavd.initial.descripcion_cavd or form_deriv_cavd.initial.fecha_derivacion_cavd or form_deriv_cavd.initial.es_vinculacion_cavd or form_deriv_cavd.initial.fecha_respuesta_cavd or form_deriv_cavd.initial.ingresa_cavd or form_deriv_cavd.initial.fecha_ingreso_cavd or form_deriv_cavd.initial.es_conmocion_publica_cavd or form_deriv_cavd.initial.fecha_vinculacion_conmocion_cavd %}table{% else %}none{% endif %}; width:100%;">
                                            <tr><td class="label-cell">Descripción</td><td class="input-cell">{{ form_deriv_cavd.descripcion_cavd|add_class:"editable-field" }}</td></tr>
                                            <tr><td class="label-cell">Fecha derivación</td><td class="input-cell">{{ form_deriv_cavd.fecha_derivacion_cavd|add_class:"editable-field" }}</td></tr>
                                            <tr><td class="label-cell">Es vinculación</td><td class="input-cell">{{ form_deriv_cavd.es_vinculacion_cavd|add_class:"editable-field" }}</td></tr>
                                            <tr><td class="label-cell">Fecha respuesta</td><td class="input-cell">{{ form_deriv_cavd.fecha_respuesta_cavd|add_class:"editable-field" }}</td></tr>
                                            <tr><td class="label-cell">Ingresa al programa</td><td class="input-cell">{{ form_deriv_cavd.ingresa_cavd|add_class:"editable-field" }}</td></tr>
                                            <tr><td class="label-cell">Fecha ingreso</td><td class="input-cell">{{ form_deriv_cavd.fecha_ingreso_cavd|add_class:"editable-field" }}</td></tr>
                                            <tr><td class="label-cell">Conmoción pública</td><td class="input-cell">{{ form_deriv_cavd.es_conmocion_publica_cavd|add_class:"editable-field" }}</td></tr>
                                            <tr><td class="label-cell">Fecha vinculación conmoción</td><td class="input-cell">{{ form_deriv_cavd.fecha_vinculacion_conmocion_cavd|add_class:"editable-field" }}</td></tr>
                                        </table>
                                    </td>
                                </tr>
                                <!-- URAVIT -->
                                <tr>
                                    <td class="label-cell">
                                        <input type="checkbox"
                                            name="deriv_uravit-check"
                                            id="deriv_uravit_chk"
                                            {% if form_deriv_uravit.initial.descripcion_uravit or form_deriv_uravit.initial.fecha_derivacion_uravit or form_deriv_uravit.initial.es_vinculacion_uravit or form_deriv_uravit.initial.fecha_respuesta_uravit %}
                                                checked
                                            {% endif %}
                                            onchange="document.getElementById('deriv_uravit_fields').style.display = this.checked ? '' : 'none';">
                                        URAVIT Fiscalía
                                    </td>
                                    <td class="input-cell">
                                        <table id="deriv_uravit_fields" style="display:{% if form_deriv_uravit.initial.descripcion_uravit or form_deriv_uravit.initial.fecha_derivacion_uravit or form_deriv_uravit.initial.es_vinculacion_uravit or form_deriv_uravit.initial.fecha_respuesta_uravit %}table{% else %}none{% endif %}; width:100%;">
                                            <tr><td class="label-cell">Descripción</td><td class="input-cell">{{ form_deriv_uravit.descripcion_uravit|add_class:"editable-field" }}</td></tr>
                                            <tr><td class="label-cell">Fecha derivación</td><td class="input-cell">{{ form_deriv_uravit.fecha_derivacion_uravit|add_class:"editable-field" }}</td></tr>
                                            <tr><td class="label-cell">Es vinculación</td><td class="input-cell">{{ form_deriv_uravit.es_vinculacion_uravit|add_class:"editable-field" }}</td></tr>
                                            <tr><td class="label-cell">Fecha respuesta</td><td class="input-cell">{{ form_deriv_uravit.fecha_respuesta_uravit|add_class:"editable-field" }}</td></tr>
                                        </table>
                                    </td>
                                </tr>
                                <!-- CDM-CAI -->
                                <tr>
                                    <td class="label-cell">
                                        <input type="checkbox"
                                            name="deriv_cdm_cai-check"
                                            id="deriv_cdm_cai_chk"
                                            {% if form_deriv_cdm_cai.initial.descripcion_cdm_cai or form_deriv_cdm_cai.initial.fecha_derivacion_cdm_cai or form_deriv_cdm_cai.initial.es_vinculacion_cdm_cai or form_deriv_cdm_cai.initial.fecha_respuesta_cdm_cai or form_deriv_cdm_cai.initial.ingresa_cdm_cai or form_deriv_cdm_cai.initial.fecha_ingreso_cdm_cai %}
                                                checked
                                            {% endif %}
                                            onchange="document.getElementById('deriv_cdm_cai_fields').style.display = this.checked ? '' : 'none';">
                                        CDM-CAI
                                    </td>
                                    <td class="input-cell">
                                        <table id="deriv_cdm_cai_fields" style="display:{% if form_deriv_cdm_cai.initial.descripcion_cdm_cai or form_deriv_cdm_cai.initial.fecha_derivacion_cdm_cai or form_deriv_cdm_cai.initial.es_vinculacion_cdm_cai or form_deriv_cdm_cai.initial.fecha_respuesta_cdm_cai or form_deriv_cdm_cai.initial.ingresa_cdm_cai or form_deriv_cdm_cai.initial.fecha_ingreso_cdm_cai %}table{% else %}none{% endif %}; width:100%;">
                                            <tr><td class="label-cell">Descripción</td><td class="input-cell">{{ form_deriv_cdm_cai.descripcion_cdm_cai|add_class:"editable-field" }}</td></tr>
                                            <tr><td class="label-cell">Fecha derivación</td><td class="input-cell">{{ form_deriv_cdm_cai.fecha_derivacion_cdm_cai|add_class:"editable-field" }}</td></tr>
                                            <tr><td class="label-cell">Es vinculación</td><td class="input-cell">{{ form_deriv_cdm_cai.es_vinculacion_cdm_cai|add_class:"editable-field" }}</td></tr>
                                            <tr><td class="label-cell">Fecha respuesta</td><td class="input-cell">{{ form_deriv_cdm_cai.fecha_respuesta_cdm_cai|add_class:"editable-field" }}</td></tr>
                                            <tr><td class="label-cell">Ingresa al programa</td><td class="input-cell">{{ form_deriv_cdm_cai.ingresa_cdm_cai|add_class:"editable-field" }}</td></tr>
                                            <tr><td class="label-cell">Fecha ingreso</td><td class="input-cell">{{ form_deriv_cdm_cai.fecha_ingreso_cdm_cai|add_class:"editable-field" }}</td></tr>
                                        </table>
                                    </td>
                                </tr>
                                <!-- Agrega el resto de las derivaciones aquí siguiendo el mismo patrón... -->
                                <!-- ...SALUD, OFAM, DIDECO, GESTIÓN TERRITORIAL, CAPS UDLA, OLN, OTRO -->
                                <!-- Te puedo entregar los bloques si los necesitas. -->
                            
                            
                                <!-- SALUD -->
                                <tr>
                                    <td class="label-cell">
                                        <input type="checkbox"
                                            name="deriv_salud-check"
                                            id="deriv_salud_chk"
                                            {% if form_deriv_salud.initial.dispositivo_salud or form_deriv_salud.initial.fecha_derivacion_salud or form_deriv_salud.initial.es_vinculacion_salud or form_deriv_salud.initial.fecha_respuesta_salud or form_deriv_salud.initial.ingresa_salud or form_deriv_salud.initial.fecha_ingreso_salud %}
                                                checked
                                            {% endif %}
                                            onchange="document.getElementById('deriv_salud_fields').style.display = this.checked ? '' : 'none';">
                                        Salud
                                    </td>
                                    <td class="input-cell">
                                        <table id="deriv_salud_fields" style="display:{% if form_deriv_salud.initial.dispositivo_salud or form_deriv_salud.initial.fecha_derivacion_salud or form_deriv_salud.initial.es_vinculacion_salud or form_deriv_salud.initial.fecha_respuesta_salud or form_deriv_salud.initial.ingresa_salud or form_deriv_salud.initial.fecha_ingreso_salud %}table{% else %}none{% endif %}; width:100%;">
                                            <tr><td class="label-cell">Dispositivo de salud</td><td class="input-cell">{{ form_deriv_salud.dispositivo_salud|add_class:"editable-field" }}</td></tr>
                                            <tr><td class="label-cell">Fecha derivación</td><td class="input-cell">{{ form_deriv_salud.fecha_derivacion_salud|add_class:"editable-field" }}</td></tr>
                                            <tr><td class="label-cell">Es vinculación</td><td class="input-cell">{{ form_deriv_salud.es_vinculacion_salud|add_class:"editable-field" }}</td></tr>
                                            <tr><td class="label-cell">Fecha respuesta</td><td class="input-cell">{{ form_deriv_salud.fecha_respuesta_salud|add_class:"editable-field" }}</td></tr>
                                            <tr><td class="label-cell">Ingresa al dispositivo</td><td class="input-cell">{{ form_deriv_salud.ingresa_salud|add_class:"editable-field" }}</td></tr>
                                            <tr><td class="label-cell">Fecha ingreso</td><td class="input-cell">{{ form_deriv_salud.fecha_ingreso_salud|add_class:"editable-field" }}</td></tr>
                                        </table>
                                    </td>
                                </tr>

                                <!-- OFAM -->
                                <tr>
                                    <td class="label-cell">
                                        <input type="checkbox"
                                            name="deriv_ofam-check"
                                            id="deriv_ofam_chk"
                                            {% if form_deriv_ofam.initial.descripcion_ofam or form_deriv_ofam.initial.fecha_derivacion_ofam or form_deriv_ofam.initial.es_vinculacion_ofam or form_deriv_ofam.initial.fecha_respuesta_ofam or form_deriv_ofam.initial.ingresa_ofam or form_deriv_ofam.initial.fecha_ingreso_ofam %}
                                                checked
                                            {% endif %}
                                            onchange="document.getElementById('deriv_ofam_fields').style.display = this.checked ? '' : 'none';">
                                        OFAM
                                    </td>
                                    <td class="input-cell">
                                        <table id="deriv_ofam_fields" style="display:{% if form_deriv_ofam.initial.descripcion_ofam or form_deriv_ofam.initial.fecha_derivacion_ofam or form_deriv_ofam.initial.es_vinculacion_ofam or form_deriv_ofam.initial.fecha_respuesta_ofam or form_deriv_ofam.initial.ingresa_ofam or form_deriv_ofam.initial.fecha_ingreso_ofam %}table{% else %}none{% endif %}; width:100%;">
                                            <tr><td class="label-cell">Descripción</td><td class="input-cell">{{ form_deriv_ofam.descripcion_ofam|add_class:"editable-field" }}</td></tr>
                                            <tr><td class="label-cell">Fecha derivación</td><td class="input-cell">{{ form_deriv_ofam.fecha_derivacion_ofam|add_class:"editable-field" }}</td></tr>
                                            <tr><td class="label-cell">Es vinculación</td><td class="input-cell">{{ form_deriv_ofam.es_vinculacion_ofam|add_class:"editable-field" }}</td></tr>
                                            <tr><td class="label-cell">Fecha respuesta</td><td class="input-cell">{{ form_deriv_ofam.fecha_respuesta_ofam|add_class:"editable-field" }}</td></tr>
                                            <tr><td class="label-cell">Ingresa al programa</td><td class="input-cell">{{ form_deriv_ofam.ingresa_ofam|add_class:"editable-field" }}</td></tr>
                                            <tr><td class="label-cell">Fecha ingreso</td><td class="input-cell">{{ form_deriv_ofam.fecha_ingreso_ofam|add_class:"editable-field" }}</td></tr>
                                        </table>
                                    </td>
                                </tr>

                                <!-- DIDECO -->
                                <tr>
                                    <td class="label-cell">
                                        <input type="checkbox"
                                            name="deriv_dideco-check"
                                            id="deriv_dideco_chk"
                                            {% if form_deriv_dideco.initial.descripcion_dideco or form_deriv_dideco.initial.fecha_derivacion_dideco or form_deriv_dideco.initial.es_vinculacion_dideco or form_deriv_dideco.initial.fecha_respuesta_dideco or form_deriv_dideco.initial.ingresa_dideco or form_deriv_dideco.initial.fecha_ingreso_dideco %}
                                                checked
                                            {% endif %}
                                            onchange="document.getElementById('deriv_dideco_fields').style.display = this.checked ? '' : 'none';">
                                        DIDECO
                                    </td>
                                    <td class="input-cell">
                                        <table id="deriv_dideco_fields" style="display:{% if form_deriv_dideco.initial.descripcion_dideco or form_deriv_dideco.initial.fecha_derivacion_dideco or form_deriv_dideco.initial.es_vinculacion_dideco or form_deriv_dideco.initial.fecha_respuesta_dideco or form_deriv_dideco.initial.ingresa_dideco or form_deriv_dideco.initial.fecha_ingreso_dideco %}table{% else %}none{% endif %}; width:100%;">
                                            <tr><td class="label-cell">Descripción</td><td class="input-cell">{{ form_deriv_dideco.descripcion_dideco|add_class:"editable-field" }}</td></tr>
                                            <tr><td class="label-cell">Fecha derivación</td><td class="input-cell">{{ form_deriv_dideco.fecha_derivacion_dideco|add_class:"editable-field" }}</td></tr>
                                            <tr><td class="label-cell">Es vinculación</td><td class="input-cell">{{ form_deriv_dideco.es_vinculacion_dideco|add_class:"editable-field" }}</td></tr>
                                            <tr><td class="label-cell">Fecha respuesta</td><td class="input-cell">{{ form_deriv_dideco.fecha_respuesta_dideco|add_class:"editable-field" }}</td></tr>
                                            <tr><td class="label-cell">Ingresa al programa</td><td class="input-cell">{{ form_deriv_dideco.ingresa_dideco|add_class:"editable-field" }}</td></tr>
                                            <tr><td class="label-cell">Fecha ingreso</td><td class="input-cell">{{ form_deriv_dideco.fecha_ingreso_dideco|add_class:"editable-field" }}</td></tr>
                                        </table>
                                    </td>
                                </tr>

                                <!-- GESTIÓN TERRITORIAL -->
                                <tr>
                                    <td class="label-cell">
                                        <input type="checkbox"
                                            name="deriv_gestion_territorial-check"
                                            id="deriv_gestion_chk"
                                            {% if form_deriv_gestion_territorial.initial.descripcion_gestion_territorial or form_deriv_gestion_territorial.initial.fecha_derivacion_gestion_territorial or form_deriv_gestion_territorial.initial.es_vinculacion_gestion_territorial or form_deriv_gestion_territorial.initial.fecha_respuesta_gestion_territorial or form_deriv_gestion_territorial.initial.ingresa_gestion_territorial or form_deriv_gestion_territorial.initial.fecha_ingreso_gestion_territorial %}
                                                checked
                                            {% endif %}
                                            onchange="document.getElementById('deriv_gestion_fields').style.display = this.checked ? '' : 'none';">
                                        Gestión Territorial
                                    </td>
                                    <td class="input-cell">
                                        <table id="deriv_gestion_fields" style="display:{% if form_deriv_gestion_territorial.initial.descripcion_gestion_territorial or form_deriv_gestion_territorial.initial.fecha_derivacion_gestion_territorial or form_deriv_gestion_territorial.initial.es_vinculacion_gestion_territorial or form_deriv_gestion_territorial.initial.fecha_respuesta_gestion_territorial or form_deriv_gestion_territorial.initial.ingresa_gestion_territorial or form_deriv_gestion_territorial.initial.fecha_ingreso_gestion_territorial %}table{% else %}none{% endif %}; width:100%;">
                                            <tr><td class="label-cell">Descripción</td><td class="input-cell">{{ form_deriv_gestion_territorial.descripcion_gestion_territorial|add_class:"editable-field" }}</td></tr>
                                            <tr><td class="label-cell">Fecha derivación</td><td class="input-cell">{{ form_deriv_gestion_territorial.fecha_derivacion_gestion_territorial|add_class:"editable-field" }}</td></tr>
                                            <tr><td class="label-cell">Es vinculación</td><td class="input-cell">{{ form_deriv_gestion_territorial.es_vinculacion_gestion_territorial|add_class:"editable-field" }}</td></tr>
                                            <tr><td class="label-cell">Fecha respuesta</td><td class="input-cell">{{ form_deriv_gestion_territorial.fecha_respuesta_gestion_territorial|add_class:"editable-field" }}</td></tr>
                                            <tr><td class="label-cell">Ingresa al programa</td><td class="input-cell">{{ form_deriv_gestion_territorial.ingresa_gestion_territorial|add_class:"editable-field" }}</td></tr>
                                            <tr><td class="label-cell">Fecha ingreso</td><td class="input-cell">{{ form_deriv_gestion_territorial.fecha_ingreso_gestion_territorial|add_class:"editable-field" }}</td></tr>
                                        </table>
                                    </td>
                                </tr>

                                <!-- CAPS UDLA -->
                                <tr>
                                    <td class="label-cell">
                                        <input type="checkbox"
                                            name="deriv_caps_udla-check"
                                            id="deriv_caps_chk"
                                            {% if form_deriv_caps_udla.initial.descripcion_caps_udla or form_deriv_caps_udla.initial.fecha_derivacion_caps_udla or form_deriv_caps_udla.initial.es_vinculacion_caps_udla or form_deriv_caps_udla.initial.fecha_respuesta_caps_udla or form_deriv_caps_udla.initial.ingresa_caps_udla or form_deriv_caps_udla.initial.fecha_ingreso_caps_udla %}
                                                checked
                                            {% endif %}
                                            onchange="document.getElementById('deriv_caps_fields').style.display = this.checked ? '' : 'none';">
                                        CAPS UDLA
                                    </td>
                                    <td class="input-cell">
                                        <table id="deriv_caps_fields" style="display:{% if form_deriv_caps_udla.initial.descripcion_caps_udla or form_deriv_caps_udla.initial.fecha_derivacion_caps_udla or form_deriv_caps_udla.initial.es_vinculacion_caps_udla or form_deriv_caps_udla.initial.fecha_respuesta_caps_udla or form_deriv_caps_udla.initial.ingresa_caps_udla or form_deriv_caps_udla.initial.fecha_ingreso_caps_udla %}table{% else %}none{% endif %}; width:100%;">
                                            <tr><td class="label-cell">Descripción</td><td class="input-cell">{{ form_deriv_caps_udla.descripcion_caps_udla|add_class:"editable-field" }}</td></tr>
                                            <tr><td class="label-cell">Fecha derivación</td><td class="input-cell">{{ form_deriv_caps_udla.fecha_derivacion_caps_udla|add_class:"editable-field" }}</td></tr>
                                            <tr><td class="label-cell">Es vinculación</td><td class="input-cell">{{ form_deriv_caps_udla.es_vinculacion_caps_udla|add_class:"editable-field" }}</td></tr>
                                            <tr><td class="label-cell">Fecha respuesta</td><td class="input-cell">{{ form_deriv_caps_udla.fecha_respuesta_caps_udla|add_class:"editable-field" }}</td></tr>
                                            <tr><td class="label-cell">Ingresa al programa</td><td class="input-cell">{{ form_deriv_caps_udla.ingresa_caps_udla|add_class:"editable-field" }}</td></tr>
                                            <tr><td class="label-cell">Fecha ingreso</td><td class="input-cell">{{ form_deriv_caps_udla.fecha_ingreso_caps_udla|add_class:"editable-field" }}</td></tr>
                                        </table>
                                    </td>
                                </tr>

                                <!-- OLN -->
                                <tr>
                                    <td class="label-cell">
                                        <input type="checkbox"
                                            name="deriv_oln-check"
                                            id="deriv_oln_chk"
                                            {% if form_deriv_oln.initial.descripcion_oln or form_deriv_oln.initial.fecha_derivacion_oln or form_deriv_oln.initial.es_vinculacion_oln or form_deriv_oln.initial.fecha_respuesta_oln or form_deriv_oln.initial.ingresa_oln or form_deriv_oln.initial.fecha_ingreso_oln %}
                                                checked
                                            {% endif %}
                                            onchange="document.getElementById('deriv_oln_fields').style.display = this.checked ? '' : 'none';">
                                        OLN
                                    </td>
                                    <td class="input-cell">
                                        <table id="deriv_oln_fields" style="display:{% if form_deriv_oln.initial.descripcion_oln or form_deriv_oln.initial.fecha_derivacion_oln or form_deriv_oln.initial.es_vinculacion_oln or form_deriv_oln.initial.fecha_respuesta_oln or form_deriv_oln.initial.ingresa_oln or form_deriv_oln.initial.fecha_ingreso_oln %}table{% else %}none{% endif %}; width:100%;">
                                            <tr><td class="label-cell">Descripción</td><td class="input-cell">{{ form_deriv_oln.descripcion_oln|add_class:"editable-field" }}</td></tr>
                                            <tr><td class="label-cell">Fecha derivación</td><td class="input-cell">{{ form_deriv_oln.fecha_derivacion_oln|add_class:"editable-field" }}</td></tr>
                                            <tr><td class="label-cell">Es vinculación</td><td class="input-cell">{{ form_deriv_oln.es_vinculacion_oln|add_class:"editable-field" }}</td></tr>
                                            <tr><td class="label-cell">Fecha respuesta</td><td class="input-cell">{{ form_deriv_oln.fecha_respuesta_oln|add_class:"editable-field" }}</td></tr>
                                            <tr><td class="label-cell">Ingresa al programa</td><td class="input-cell">{{ form_deriv_oln.ingresa_oln|add_class:"editable-field" }}</td></tr>
                                            <tr><td class="label-cell">Fecha ingreso</td><td class="input-cell">{{ form_deriv_oln.fecha_ingreso_oln|add_class:"editable-field" }}</td></tr>
                                        </table>
                                    </td>
                                </tr>

                                <!-- OTRO -->
                                <tr>
                                    <td class="label-cell">
                                        <input type="checkbox"
                                            name="deriv_otro-check"
                                            id="deriv_otro_chk"
                                            {% if form_deriv_otro.initial.institucion_otro or form_deriv_otro.initial.descripcion_otro or form_deriv_otro.initial.fecha_derivacion_otro or form_deriv_otro.initial.es_vinculacion_otro or form_deriv_otro.initial.fecha_respuesta_otro or form_deriv_otro.initial.ingresa_otro or form_deriv_otro.initial.fecha_ingreso_otro %}
                                                checked
                                            {% endif %}
                                            onchange="document.getElementById('deriv_otro_fields').style.display = this.checked ? '' : 'none';">
                                        Otro
                                    </td>
                                    <td class="input-cell">
                                        <table id="deriv_otro_fields" style="display:{% if form_deriv_otro.initial.institucion_otro or form_deriv_otro.initial.descripcion_otro or form_deriv_otro.initial.fecha_derivacion_otro or form_deriv_otro.initial.es_vinculacion_otro or form_deriv_otro.initial.fecha_respuesta_otro or form_deriv_otro.initial.ingresa_otro or form_deriv_otro.initial.fecha_ingreso_otro %}table{% else %}none{% endif %}; width:100%;">
                                            <tr><td class="label-cell">Institución (otro)</td><td class="input-cell">{{ form_deriv_otro.institucion_otro|add_class:"editable-field" }}</td></tr>
                                            <tr><td class="label-cell">Descripción</td><td class="input-cell">{{ form_deriv_otro.descripcion_otro|add_class:"editable-field" }}</td></tr>
                                            <tr><td class="label-cell">Fecha derivación</td><td class="input-cell">{{ form_deriv_otro.fecha_derivacion_otro|add_class:"editable-field" }}</td></tr>
                                            <tr><td class="label-cell">Es vinculación</td><td class="input-cell">{{ form_deriv_otro.es_vinculacion_otro|add_class:"editable-field" }}</td></tr>
                                            <tr><td class="label-cell">Fecha respuesta</td><td class="input-cell">{{ form_deriv_otro.fecha_respuesta_otro|add_class:"editable-field" }}</td></tr>
                                            <tr><td class="label-cell">Ingresa al programa</td><td class="input-cell">{{ form_deriv_otro.ingresa_otro|add_class:"editable-field" }}</td></tr>
                                            <tr><td class="label-cell">Fecha ingreso</td><td class="input-cell">{{ form_deriv_otro.fecha_ingreso_otro|add_class:"editable-field" }}</td></tr>
                                        </table>
                                    </td>
                                </tr>
                            
                            </tbody>
                        </table>

                    </div>
                </div>
            </div>
            <!-- FIN Acordeón Derivaciones -->

        <div class="form-footer text-center mt-4">
            <a href="{% url 'fichas:ver_ficha_completa' ficha.id %}" class="btn btn-secondary btn-lg">Cancelar</a>
            <button type="submit" class="btn btn-institucional btn-lg">
                Guardar Cambios
            </button>
        </div>
    </form>
</div>




<script src="{% static 'fichas/js/ficha_completa.js' %}"></script>


<!-- Modal de advertencia de cambios en campos ya llenos -->
<div class="modal fade" id="confirmarCambiosCamposModal" tabindex="-1" aria-labelledby="confirmarCambiosCamposLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius: 18px; border: 2px solid #252c54;">
      <div class="modal-header" style="background-color: #252c54; color: white; border-radius: 18px 18px 0 0;">
        <h5 class="modal-title" id="confirmarCambiosCamposLabel" style="font-weight:bold; letter-spacing:0.5px;">Advertencia</h5>
      </div>
      <div class="modal-body" style="padding: 26px;">
        Estás modificando datos que ya estaban registrados previamente.<br><br>
        ¿Estás segura/o de que deseas cambiar estos datos?
      </div>
      <div class="modal-footer d-flex justify-content-center" style="border-radius: 0 0 18px 18px; background-color:#f4f6f8;">
        <button type="button" class="btn-descartar" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" id="confirmarCambiosCamposBtn" class="btn-institucional">Sí, modificar</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll('.editable-field').forEach(function(input){
        if(input.value && input.value !== "") {
            input.setAttribute('data-original', input.value);
        }
    });
    document.querySelectorAll('textarea').forEach(function(textarea){
        const baseHeight = textarea.scrollHeight;
        textarea.style.height = baseHeight + 'px';
        textarea.addEventListener('input', function(){
            if(textarea.scrollHeight > textarea.offsetHeight){
                textarea.style.height = 'auto';
                textarea.style.height = textarea.scrollHeight + 'px';
            }
        });
    });
    let fieldsWithOriginalChange = [];
    document.querySelectorAll('.editable-field').forEach(function(input){
        input.addEventListener('change', function(){
            let original = input.getAttribute('data-original');
            if(original !== null && original !== "" && input.value !== original){
                if(!fieldsWithOriginalChange.includes(input)){
                    fieldsWithOriginalChange.push(input);
                }
            } else {
                let idx = fieldsWithOriginalChange.indexOf(input);
                if(idx !== -1) fieldsWithOriginalChange.splice(idx,1);
            }
        });
    });
    document.getElementById("formFicha").addEventListener("submit", function(e){
        if(fieldsWithOriginalChange.length > 0){
            e.preventDefault();
            var modal = new bootstrap.Modal(document.getElementById('confirmarCambiosCamposModal'));
            modal.show();
            document.getElementById("confirmarCambiosCamposBtn").onclick = function(){
                modal.hide();
                fieldsWithOriginalChange = [];
                document.getElementById("formFicha").submit();
            };
        }
    });
    let isFormDirty = false;
    document.getElementById("formFicha").addEventListener("input", function () {
        isFormDirty = true;
    });
    window.addEventListener("beforeunload", function (e) {
        if (isFormDirty) {
            e.preventDefault();
            e.returnValue = '';
        }
    });
    document.getElementById("formFicha").addEventListener("submit", function () {
        isFormDirty = false;
    });
});
</script>



{% endblock %}
