{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}
{% block content %}

<style>
body {
    font-family: Arial, sans-serif;
    background-color: #f4f6f8;
    margin: 0;
    padding: 0;
}

.form-container {
    max-width: 100%;
    margin: 0 auto;
    background-color: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    overflow-x: auto;
}

/* Tablas */
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}

th {
    background-color: #252c54 ;
    color: white;
    font-size: 14px;
    padding: 8px;
    text-align: left;
}

td.label-cell {
    background-color: #252c54 ;
    color: white;
    width: 25%;
    font-weight: bold;
    padding: 8px;
    vertical-align: top;
}

td.input-cell {
    width: 75%;
    padding: 8px;
    vertical-align: top;
}


/* Inputs */
input[type="text"],
input[type="date"],
select {
    width: 100%;
    padding: 6px;
    font-size: 14px;
    border: 1px solid #ccc;
    border-radius: 4px;
}

/* Botones */
.btn-primary {
    background-color: #252c54 ;
    color: white;
    border: none;
}

.btn-secondary {
    background-color: #ccc;
    color: #000;
    text-decoration: none;
}

/* Bordes blancos para tablas */
table, th, td {
    border: 1px solid white;
}

/* Acordeón */
.accordion-button {
    background-color: #252c54 ;
    color: white;
}

.accordion-button:not(.collapsed) {
    background-color: #e60380 ;
    color: white;
}

.accordion-button:focus {
    box-shadow: none;
    outline: none;
}

/* Responsive */
@media (max-width: 768px) {
    table, thead, tbody, th, td, tr {
        display: block;
        width: 100%;
    }
    th, td {
        border: 1px solid white;
    }
}
@media (max-width: 768px) {
    td.input-cell,
    td.label-cell {
        display: block;
        width: 100%;
    }
}



textarea {
    min-height: 40px;
    max-height: 500px;
    overflow-y: hidden;
    resize: vertical;
    padding: 6px;
    font-size: 14px;
    width: 100%;
    box-sizing: border-box;
}



.table-responsive-preingreso {
    overflow-x: auto;
    width: 100%;
}

.table-responsive-preingreso table {
    min-width: 900px; /* o el ancho que necesites */
}

.checkbox-textarea-row {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
}

.checkbox-textarea-row input[type="checkbox"] {
    margin-right: 8px;
    margin-left: 2px;
    /* Si necesitas que sea más grande: */
    /* transform: scale(1.4); */
}

.checkbox-textarea-row textarea {
    flex: 1 1 auto;
    min-height: 45px;
    margin-left: 0;
}

.btn-institucional {
    background-color: #252c54;
    color: #fff;
    border: none;
    padding: 12px 32px;
    border-radius: 6px;
    font-size: 1.2rem;
    font-weight: bold;
    box-shadow: 0 2px 8px rgba(37, 44, 84, 0.15);
    transition: background 0.2s, box-shadow 0.2s;
    margin-top: 12px;
}

.btn-institucional:hover, .btn-institucional:focus {
    background-color: #1a2040;
    color: #fff;
    box-shadow: 0 4px 12px rgba(37, 44, 84, 0.20);
    outline: none;
}

.form-footer {
    margin-bottom: 30px;
}


.espacio-fila td {
    padding: 0 !important;
    border: none !important;
    height: 12px; /* O el espacio que prefieras */
    background: transparent !important;
}

.radio-inline {
    display: flex;
    gap: 14px;
    align-items: center;
    /* Para mantener alineado en celdas altas */
}
.radio-inline label {
    margin-right: 6px;
    margin-bottom: 0 !important;
    font-weight: normal;
}
.radio-inline input[type="radio"] {
    margin-right: 4px;
}


</style>

{% comment %} ALERTA DE ERRORES GLOBAL {% endcomment %}
{% if form_ficha.errors or form_persona.errors or form_denuncia.errors or form_motivo.errors or form_psico.errors or form_redes.errors or form_plan.errors %}
  <div class="alert alert-danger" style="margin-bottom:20px;">
    <ul style="margin-bottom:0;">
      {# Errores por campo de todos los formularios #}
      {% for form in forms_list %}

        {% for field in form %}
          {% for error in field.errors %}
            <li>
              <strong>{{ field.label }}:</strong> {{ error }}
            </li>
          {% endfor %}
        {% endfor %}
        {# Errores no asociados a campos (del método clean()) #}
        {% for error in form.non_field_errors %}
          <li>
            {{ error }}
          </li>
        {% endfor %}
      {% endfor %}
    </ul>
  </div>
{% endif %}




<div class="container mt-4">
    <h2 class="mb-4" style="color:#252c54;font-weight:700;">Nueva Ficha de Acogida</h2>

    <form method="post" id="formFicha">
        {% csrf_token %}

        <div class="accordion" id="formAccordion">

            <!-- Acordeón 1: Preingreso + Individualización + Denuncia -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingPreingreso">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePreingreso">
                        Preingreso e Individualización
                    </button>
                </h2>
                <div id="collapsePreingreso" class="accordion-collapse collapse show" data-bs-parent="#formAccordion">
                    <div class="accordion-body">

                        <!-- PREINGRESO -->
                        <h4 class="mb-3">Módulo 1A: Preingreso</h4>
                        <div class="table-responsive-preingreso">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Fecha recepción</th>
                                        <th>Vía de ingreso</th>
                                        <th>Fecha contacto 1</th>
                                        <th>Fecha contacto 2</th>
                                        <th>Fecha contacto 3</th>
                                        <th>Tipo de contacto</th>
                                        <th>¿Ingreso efectivo?</th>
                                        <th>Fecha de ingreso</th>
                                        <th>Profesionales primer contacto</th>
                                        <th>¿Recibió contención inicial?</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>{{ form_ficha.fecha_recepcion }}
                                                {% for error in form_ficha.fecha_recepcion.errors %}
                                                    <div class="text-danger" style="color:#e60380;">{{ error }}</div>
                                                {% endfor %}
                                        </td>
                                        <td>{{ form_ficha.via_ingreso }}</td>
                                        <td>{{ form_ficha.fecha_contacto_1 }}</td>
                                        <td>{{ form_ficha.fecha_contacto_2 }}</td>
                                        <td>{{ form_ficha.fecha_contacto_3 }}</td>
                                        <td>{{ form_ficha.tipo_contacto }}</td>
                                        <td>{{ form_ficha.ingreso_efectivo }}</td>
                                        <td>{{ form_ficha.fecha_ingreso }}</td>
                                        <td>{{ form_ficha.profesionales_contacto_1 }}</td>
                                        <td>{{ form_ficha.contencion_inicial }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>



                        <!-- PERSONA ATENDIDA -->
                        <h4 class="mt-5 mb-3">Módulo 1B: Datos de la Persona Atendida</h4>
                        <table>
                            <tbody>
                                <tr><td class="label-cell">Nombre</td><td class="input-cell">{{ form_persona.nombre }}</td></tr>
                                <tr><td class="label-cell">RUT / Nº Pasaporte</td><td class="input-cell">{{ form_persona.rut_pasaporte }}</td></tr>
                                <tr>
                                    <td class="label-cell">Género</td>
                                    <td class="input-cell">
                                        {{ form_persona.genero|add_class:"select-genero" }}
                                        <div id="genero-otro-campo" style="display:none; margin-top:6px;">
                                            {{ form_persona.genero_otro }}
                                        </div>
                                    </td>
                                </tr>

                                <tr><td class="label-cell">Teléfono</td><td class="input-cell">{{ form_persona.telefono }}</td></tr>
                                <tr><td class="label-cell">Fecha de Nacimiento</td><td class="input-cell">{{ form_persona.fecha_nacimiento }}</td></tr>
                                <tr id="fila-rango-etareo">
                                    <td class="label-cell">Rango etáreo</td>
                                    <td class="input-cell">
                                        <div id="rango-etareo-select-wrapper">
                                            {{ form_persona.rango_etareo|add_class:"select-rango-etareo"|attr:"id:id_rango_etareo" }}
                                        </div>
                                        <div id="rango-etareo-readonly-wrapper" style="display:none;">
                                            <input type="text"
                                                id="rango-etareo-readonly"
                                                class="form-control"
                                                value=""
                                                readonly>
                                        </div>
                                    </td>
                                </tr>                                


                                

                                <tr>
                                    <td class="label-cell">País de Nacionalidad</td>
                                    <td class="input-cell">
                                        {{ form_persona.nacionalidad|add_class:"select2" }}
                                        <div id="nacionalidad-otro-campo" style="display:none; margin-top:6px;">
                                            {{ form_persona.nacionalidad_otro }}
                                        </div>
                                    </td>

                                </tr>
                                

                                <tr><td class="label-cell">Estado Civil</td><td class="input-cell">{{ form_persona.estado_civil }}</td></tr>
                                <tr><td class="label-cell">Previsión</td><td class="input-cell">{{ form_persona.prevision }}</td></tr>
                                <tr>
                                    <td class="label-cell">CESFAM Vinculante</td>
                                    <td class="input-cell">
                                        {{ form_persona.cesfam }}
                                        <div id="cesfam-otro-campo" style="display:none; margin-top:6px;">
                                            {{ form_persona.cesfam_otro }}
                                        </div>
                                    </td>
                                </tr>
                                <tr><td class="label-cell">Ocupación</td><td class="input-cell">{{ form_persona.ocupacion }}</td></tr>
                                <tr class="espacio-fila"><td colspan="2"></td></tr>
                                <tr><td class="label-cell">Dirección</td><td class="input-cell">{{ form_persona.direccion }}</td></tr>
                                <tr><td class="label-cell">Villa</td><td class="input-cell">{{ form_persona.villa }}</td></tr>
                                <tr><td class="label-cell">Barrio</td><td class="input-cell">{{ form_persona.barrio }}</td></tr>
                                <tr><td class="label-cell">Cuadrante</td><td class="input-cell">{{ form_persona.cuadrante }}</td></tr>
                                <tr class="espacio-fila"><td colspan="2"></td></tr>
                                <tr><td class="label-cell">¿Situación de Discapacidad?</td><td class="input-cell">{{ form_persona.discapacidad }}</td></tr>
                                <tr><td class="label-cell">¿Pertenencia a pueblo originario / etnia?</td><td class="input-cell">{{ form_persona.etnia }}</td></tr>
                                <tr><td class="label-cell">¿Diversidad (sexo/género/orientación)?</td><td class="input-cell">{{ form_persona.diversidad }}</td></tr>
                                <tr><td class="label-cell">Nombre de persona significativa</td><td class="input-cell">{{ form_persona.persona_significativa }}</td></tr>
                                <tr class="espacio-fila"><td colspan="2"></td></tr>
                                <tr><td class="label-cell">Vínculo con persona significativa</td><td class="input-cell">{{ form_persona.vinculo }}</td></tr>
                                <tr><td class="label-cell">Teléfono significativo</td><td class="input-cell">{{ form_persona.telefono_significativo }}</td></tr>
                                <tr>
                                    <td class="label-cell">N° adultos hogar</td>
                                    <td class="input-cell">
                                        {{ form_persona.n_adultos|add_class:"input-integrantes" | attr:"id:id_n_adultos" }}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="label-cell">N° NNA hogar</td>
                                    <td class="input-cell">
                                        {{ form_persona.n_nna|add_class:"input-integrantes" | attr:"id:id_n_nna" }}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="label-cell"><strong>Total integrantes hogar</strong></td>
                                    <td class="input-cell">
                                        <span id="total-integrantes" style="font-weight:bold;">0</span>
                                    </td>
                                </tr>


                            </tbody>
                        </table>



                        <!-- DENUNCIA -->
                        <h4 class="mt-5 mb-3">Módulo 1C: Denuncia</h4>
                        <table>
                            <tbody>
                                <!-- Siempre visibles -->
                                <tr>
                                    <td class="label-cell">¿Realizó denuncia?</td>
                                    <td class="input-cell">{{ form_denuncia.tiene_denuncia }}</td>
                                </tr>
                                <tr>
                                    <td class="label-cell">Dificultades en la denuncia</td>
                                    <td class="input-cell">
                                        {{ form_denuncia.dificultades }}
                                        <div id="dificultades-otra-campo" style="display:none; margin-top:6px;">
                                            {{ form_denuncia.dificultades_otra }}
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                            <tbody id="denuncia-detalle-campos" style="display: none;">
                                <tr>
                                    <td class="label-cell">Año de la denuncia</td>
                                    <td class="input-cell">{{ form_denuncia.anio_denuncia }}</td>
                                </tr>
                                <tr>
                                    <td class="label-cell">Lugar de denuncia</td>
                                    <td class="input-cell">
                                        {{ form_denuncia.lugar_denuncia }}
                                        <div id="otro-lugar-campo" style="display:none; margin-top:6px;">
                                            {{ form_denuncia.lugar_denuncia_otro }}
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="label-cell">Número de causa</td>
                                    <td class="input-cell">{{ form_denuncia.numero_causa }}</td>
                                </tr>
                                <tr>
                                    <td class="label-cell">Motivo denuncia</td>
                                    <td class="input-cell">{{ form_denuncia.motivo_denuncia }}</td>
                                </tr>
                                <tr>
                                    <td class="label-cell">¿Medida cautelar?</td>
                                    <td class="input-cell">
                                        {{ form_denuncia.medida_cautelar }}
                                        <div id="medida-cautelar-detalle-campo" style="display:none; margin-top:6px;">
                                            {{ form_denuncia.medida_cautelar_detalle }}
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                                        
</div> <!-- .accordion-body -->
</div> <!-- #collapsePreingreso -->
</div> <!-- .accordion-item -->

            <!-- Acordeón 2: Motivo -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingMotivo">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMotivo">
                        Motivo de Ingreso
                    </button>
                </h2>
                <div id="collapseMotivo" class="accordion-collapse collapse" data-bs-parent="#formAccordion">
                    <div class="accordion-body">

                        <table>
                            <tbody>
                                <tr>
                                    <td class="label-cell">Motivo principal</td>
                                    <td class="input-cell">
                                        {{ form_motivo.motivo_ingreso|add_class:"select-motivo-ingreso"|attr:"id:id_motivo_ingreso" }}
                                    </td>
                                </tr>
                                <tr id="motivo-otro-row" style="display:none;">
                                    <td class="label-cell">Si seleccionó Otro, especifique</td>
                                    <td class="input-cell">
                                        {{ form_motivo.motivo_otro }}
                                        {% if form_motivo.motivo_otro.help_text %}
                                        <small class="form-text text-muted">{{ form_motivo.motivo_otro.help_text }}</small>
                                        {% endif %}
                                        {% for error in form_motivo.motivo_otro.errors %}
                                        <div class="text-danger" style="color:#e60380;">{{ error }}</div>
                                        {% endfor %}
                                    </td>
                                </tr>                                
                                              
                                <tr>
                                    <td class="label-cell">Descripción del caso</td>
                                    <td class="input-cell">{{ form_motivo.descripcion_motivo }}</td> 
                                    <small class="form-text text-muted">Describe brevemente los hechos relatados por la persona atendida al momento del ingreso.</small>
                                </tr>





                            </tbody>
                        </table>

                    </div>
                </div>
            </div>


            <!-- Acordeón 3: Psicológico -->
            <!-- Acordeón 3: Aspectos Psicológicos y Salud Mental -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingPsico">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePsico">
                        Aspectos Psicológicos y Salud Mental
                    </button>
                </h2>
                <div id="collapsePsico" class="accordion-collapse collapse" data-bs-parent="#formAccordion">
                    <div class="accordion-body">

                        <table>
                            <tbody>
                                <tr>
                                    <td class="label-cell">Antecedentes</td>
                                    <td class="input-cell">
                                        {{ form_psico.antecedentes }}
                                        <small class="form-text text-muted">Ingrese antecedentes relevantes en salud mental.</small>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="label-cell">Diagnóstico</td>
                                    <td class="input-cell">
                                        {{ form_psico.diagnostico }}
                                        <small class="form-text text-muted">Seleccione un diagnóstico. Si selecciona "Otro", especifique más abajo.</small>
                                    </td>
                                </tr>
                                <tr id="diagnostico-otro-row" style="display:none;">
                                    <td class="label-cell">Otro diagnóstico (especifique)</td>
                                    <td class="input-cell">
                                        {{ form_psico.diagnostico_otro }}
                                        {% for error in form_psico.diagnostico_otro.errors %}
                                            <div class="text-danger" style="color:#e60380;">{{ error }}</div>
                                        {% endfor %}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="label-cell">¿Ha tenido atención en salud mental?</td>
                                    <td class="input-cell">
                                        {{ form_psico.atencion_salud_mental }}
                                    </td>
                                </tr>
                                <tr id="atencion-anio-row" style="display:none;">
                                    <td class="label-cell">Año de atención</td>
                                    <td class="input-cell">
                                        {{ form_psico.atencion_anio }}
                                    </td>
                                </tr>
                                <tr id="atencion-lugar-row" style="display:none;">
                                    <td class="label-cell">Lugar de atención</td>
                                    <td class="input-cell">
                                        {{ form_psico.atencion_lugar }}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="label-cell">¿Ha tenido internaciones?</td>
                                    <td class="input-cell">
                                        {{ form_psico.internacion }}
                                    </td>
                                </tr>
                                <tr id="internacion-anio-row" style="display:none;">
                                    <td class="label-cell">Año de internación</td>
                                    <td class="input-cell">
                                        {{ form_psico.internacion_anio }}
                                    </td>
                                </tr>
                                <tr id="internacion-lugar-row" style="display:none;">
                                    <td class="label-cell">Lugar de internación</td>
                                    <td class="input-cell">
                                        {{ form_psico.internacion_lugar }}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="label-cell">Ideación y/o intentos suicidas  ( año, motivo, otros, especifique)</td>
                                    <td class="input-cell">
                                        {{ form_psico.afectacion_psicologica }}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <hr>
                        <!-- Campos multiseleccionables (opcional agrupar en una fila de dos columnas para visual) -->
                        <h5 class="mt-4" style="color:#252c54">Afectación ámbito psicológico</h5>
                        <table>
                            <tbody>
                                <tr>
                                    <td class="label-cell">Estado de conciencia</td>
                                    <td class="input-cell">{{ form_psico.estado_conciencia }}</td>
                                </tr>
                                <tr>
                                    <td class="label-cell">Orientación</td>
                                    <td class="input-cell">{{ form_psico.orientacion }}</td>
                                </tr>
                                <tr>
                                    <td class="label-cell">Estado cognitivo</td>
                                    <td class="input-cell">{{ form_psico.estado_cognitivo }}</td>
                                </tr>
                                <tr>
                                    <td class="label-cell">Actitud</td>
                                    <td class="input-cell">{{ form_psico.actitud }}</td>
                                </tr>
                                <tr>
                                    <td class="label-cell">Lenguaje</td>
                                    <td class="input-cell">{{ form_psico.lenguaje }}</td>
                                </tr>
                                <tr>
                                    <td class="label-cell">Afectividad</td>
                                    <td class="input-cell">{{ form_psico.afectividad }}</td>
                                </tr>
                                <tr>
                                    <td class="label-cell">Sueño</td>
                                    <td class="input-cell">{{ form_psico.sueno }}</td>
                                </tr>
                                <tr>
                                    <td class="label-cell">Alimentación</td>
                                    <td class="input-cell">{{ form_psico.alimentacion }}</td>
                                </tr>
                                <tr>
                                    <td class="label-cell">Limitación vida cotidiana</td>
                                    <td class="input-cell">{{ form_psico.limitacion_vida_cotidiana }}</td>
                                </tr>
                                <tr>
                                    <td class="label-cell">¿Quiebre en historia de vida?</td>
                                    <td class="input-cell">{{ form_psico.quiebre_historia_vida }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>


            <!-- Acordeón 4: Redes de Apoyo -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingRedes">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseRedes">
                        Redes de Apoyo
                    </button>
                </h2>
                <div id="collapseRedes" class="accordion-collapse collapse" data-bs-parent="#formAccordion">
                    <div class="accordion-body">

                        <table>
                            <tbody>
                                <tr>
                                    <td colspan="2" style="background:#eee; color:#252c54; font-weight:bold; font-size:16px;">
                                        Redes Personales
                                    </td>
                                </tr>
                                <tr><td class="label-cell">Red familiares</td><td class="input-cell">{{ form_redes.red_familiares }}</td></tr>
                                <tr><td class="label-cell">Red amistades</td><td class="input-cell">{{ form_redes.red_amistades }}</td></tr>
                                <tr><td class="label-cell">Red cónyuge</td><td class="input-cell">{{ form_redes.red_conyuge }}</td></tr>
                                <tr><td class="label-cell">Red laborales</td><td class="input-cell">{{ form_redes.red_laborales }}</td></tr>
                                <tr><td class="label-cell">Red otros personales</td><td class="input-cell">{{ form_redes.red_otros_personales }}</td></tr>
                                                        
                                <tr>
                                    <td colspan="2" style="background:#eee; color:#252c54; font-weight:bold; font-size:16px;">
                                        Redes Comunitarias
                                    </td>
                                </tr>
                                <tr><td class="label-cell">Red junta de vecinos</td><td class="input-cell">{{ form_redes.red_junta_vecinos }}</td></tr>
                                <tr><td class="label-cell">Red centro de madres</td><td class="input-cell">{{ form_redes.red_centro_madres }}</td></tr>
                                <tr><td class="label-cell">Red club de adultos mayores</td><td class="input-cell">{{ form_redes.red_club_adultos }}</td></tr>
                                <tr><td class="label-cell">Red club deportivo</td><td class="input-cell">{{ form_redes.red_club_deportivo }}</td></tr>
                                <tr><td class="label-cell">Red otros comunitarios</td><td class="input-cell">{{ form_redes.red_otros_comunitarios }}</td></tr>

                                <tr>
                                    <td colspan="2" style="background:#eee; color:#252c54; font-weight:bold; font-size:16px;">
                                        Redes Institucionales
                                    </td>
                                </tr>
                                <tr><td class="label-cell">Red Municipalidad</td><td class="input-cell">{{ form_redes.red_municipalidad }}</td></tr>
                                <tr><td class="label-cell">Red CESFAM</td><td class="input-cell">{{ form_redes.red_cesfam }}</td></tr>
                                <tr><td class="label-cell">Red establecimiento educativo</td><td class="input-cell">{{ form_redes.red_establecimiento }}</td></tr>
                                <tr><td class="label-cell">Red ONG</td><td class="input-cell">{{ form_redes.red_ong }}</td></tr>                               
                                <tr><td class="label-cell">Red COSAM</td><td class="input-cell">{{ form_redes.red_cosam }}</td></tr>
                                <tr><td class="label-cell">Otra</td><td class="input-cell">{{ form_redes.red_otro_salud }}</td></tr>        
                            </tbody>
                        </table>

                    </div>
                </div>
            </div>


            <!-- Acordeón 5: Plan de Acción -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingPlan">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePlan">
                        Plan de Acción
                    </button>
                </h2>
                <div id="collapsePlan" class="accordion-collapse collapse" data-bs-parent="#formAccordion">
                    <div class="accordion-body">
                        <table>
                            <tbody>
                               
                                <!-- UAV Atención Psicológica -->
                                <tr>
                                    <td class="label-cell" rowspan="3"><strong>UAV Atención Psicológica</strong></td>
                                    <td class="input-cell">
                                        <div class="checkbox-textarea-row">
                                            {{ form_plan.uav_psicologica_1 }} {{ form_plan.uav_psicologica_1_detalle }}
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="input-cell">
                                        <div class="checkbox-textarea-row">
                                            {{ form_plan.uav_psicologica_2 }} {{ form_plan.uav_psicologica_2_detalle }}
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="input-cell">
                                        <div class="checkbox-textarea-row">
                                            {{ form_plan.uav_psicologica_3 }} {{ form_plan.uav_psicologica_3_detalle }}
                                        </div>
                                    </td>
                                </tr>
                                <!-- UAV Atención Social -->
                                <tr>
                                    <td class="label-cell" rowspan="3"><strong>UAV Atención Social</strong></td>
                                    <td class="input-cell">
                                        <div class="checkbox-textarea-row">
                                            {{ form_plan.uav_social_1 }} {{ form_plan.uav_social_1_detalle }}
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="input-cell">
                                        <div class="checkbox-textarea-row">
                                            {{ form_plan.uav_social_2 }} {{ form_plan.uav_social_2_detalle }}
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="input-cell">
                                        <div class="checkbox-textarea-row">
                                            {{ form_plan.uav_social_3 }} {{ form_plan.uav_social_3_detalle }}
                                        </div>
                                    </td>
                                </tr>
                                <!-- UAV Atención Legal -->
                                <tr>
                                    <td class="label-cell" rowspan="3"><strong>UAV Atención Legal</strong></td>
                                    <td class="input-cell">
                                        <div class="checkbox-textarea-row">
                                            {{ form_plan.uav_legal_1 }} {{ form_plan.uav_legal_1_detalle }}
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="input-cell">
                                        <div class="checkbox-textarea-row">
                                            {{ form_plan.uav_legal_2 }} {{ form_plan.uav_legal_2_detalle }}
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="input-cell">
                                        <div class="checkbox-textarea-row">
                                            {{ form_plan.uav_legal_3 }} {{ form_plan.uav_legal_3_detalle }}
                                        </div>
                                    </td>
                                </tr>
                                <!-- Patrullaje Preventivo (cada parte en fila propia) -->
                                <tr>
                                    <td class="label-cell"><strong>Patrullaje preventivo</strong></td>
                                    <td class="input-cell">
                                        {{ form_plan.patrullaje_activo }} Activar patrullaje preventivo
                                    </td>
                                </tr>
                                <tr class="patrullaje-campos" style="display:none;">
                                    <td class="label-cell"></td>
                                    <td class="input-cell">
                                        {{ form_plan.patrullaje_turno_1 }} 1° Turno (07:00 a 15:00 hrs) /
                                        {{ form_plan.patrullaje_entrevista_1 }} Entrevista
                                    </td>
                                </tr>
                                <tr class="patrullaje-campos" style="display:none;">
                                    <td class="label-cell"></td>
                                    <td class="input-cell">
                                        {{ form_plan.patrullaje_turno_2 }} 2° Turno (15:00 a 23:00 hrs) /
                                        {{ form_plan.patrullaje_entrevista_2 }} Entrevista
                                    </td>
                                </tr>
                                <tr class="patrullaje-campos" style="display:none;">
                                    <td class="label-cell"></td>
                                    <td class="input-cell">
                                        {{ form_plan.patrullaje_turno_3 }} 3° Turno (23:00 a 07:00 hrs) /
                                        {{ form_plan.patrullaje_entrevista_3 }} Entrevista
                                    </td>
                                </tr>
                                <tr class="patrullaje-campos" style="display:none;">
                                    <td class="label-cell"></td>
                                    <td class="input-cell">
                                        <label for="id_registro_patrullaje">N° de registro patrullaje</label>
                                        {{ form_plan.registro_patrullaje }}
                                        <small class="form-text text-muted">Ejemplo: 2025-0001</small>
                                    </td>
                                </tr>
                                <!-- Profesional a cargo -->
                                <tr>
                                    <td class="label-cell"><strong>Profesional a cargo</strong></td>
                                    <td class="input-cell">
                                        {{ form_plan.profesional_nathaly }} Nathaly Reyes<br>
                                        {{ form_plan.profesional_paloma }} Paloma Quinteros<br>
                                        {{ form_plan.cordinadora_gloria }} Gloria Rivera<br>
                                    </td>
                                </tr>
                                       </tbody>
                                    </table>        
                    </div>
                </div>
            </div>

        <!-- Acordeón 6: Derivaciones -->
        <div class="accordion-item">
        <h2 class="accordion-header" id="headingDerivaciones">
            <button class="accordion-button collapsed" type="button"
                    data-bs-toggle="collapse" data-bs-target="#collapseDerivaciones">
            Derivaciones
            </button>
        </h2>
        <div id="collapseDerivaciones" class="accordion-collapse collapse"
            data-bs-parent="#formAccordion">
            <div class="accordion-body">

            <table>
                <tbody>

                <!-- CAVD -->
                <tr>
                    <td class="label-cell">
                    <input type="checkbox"
                            name="deriv_cavd-check"
                            id="deriv_cavd_chk"
                            onchange="document.getElementById('deriv_cavd_fields').style.display = this.checked ? '' : 'none';">
                    Programa Atención a Víctimas (CAVD)
                    </td>
                    <td class="input-cell">
                    <table id="deriv_cavd_fields" style="display:none; width:100%;">
                        <tr>
                        <td class="label-cell">Descripción</td>
                        <td class="input-cell">{{ deriv_cavd.descripcion_cavd }}</td>
                        </tr>
                        <tr>
                        <td class="label-cell">Fecha derivación</td>
                        <td class="input-cell">{{ deriv_cavd.fecha_derivacion_cavd }}</td>
                        </tr>
                        <tr>
                        <td class="label-cell">Es vinculación</td>
                        <td class="input-cell">{{ deriv_cavd.es_vinculacion_cavd }}</td>
                        </tr>
                        <tr>
                        <td class="label-cell">Fecha respuesta</td>
                        <td class="input-cell">{{ deriv_cavd.fecha_respuesta_cavd }}</td>
                        </tr>
                        <tr>
                        <td class="label-cell">Ingresa al programa</td>
                        <td class="input-cell">{{ deriv_cavd.ingresa_cavd }}</td>
                        </tr>
                        <tr>
                        <td class="label-cell">Fecha ingreso</td>
                        <td class="input-cell">{{ deriv_cavd.fecha_ingreso_cavd }}</td>
                        </tr>
                        <tr>
                        <td class="label-cell">Conmoción pública</td>
                        <td class="input-cell">{{ deriv_cavd.es_conmocion_publica_cavd }}</td>
                        </tr>
                        <tr>
                        <td class="label-cell">Fecha vinculación conmoción</td>
                        <td class="input-cell">{{ deriv_cavd.fecha_vinculacion_conmocion_cavd }}</td>
                        </tr>
                    </table>
                    </td>
                </tr>

                <!-- URAVIT -->
                <tr>
                    <td class="label-cell">
                    <input type="checkbox"
                            name="deriv_uravit-check"
                            id="deriv_uravit_chk"
                            onchange="document.getElementById('deriv_uravit_fields').style.display = this.checked ? '' : 'none';">
                    URAVIT Fiscalía
                    </td>
                    <td class="input-cell">
                    <table id="deriv_uravit_fields" style="display:none; width:100%;">
                        <tr>
                        <td class="label-cell">Descripción</td>
                        <td class="input-cell">{{ deriv_uravit.descripcion_uravit }}</td>
                        </tr>
                        <tr>
                        <td class="label-cell">Fecha derivación</td>
                        <td class="input-cell">{{ deriv_uravit.fecha_derivacion_uravit }}</td>
                        </tr>
                        <tr>
                        <td class="label-cell">Es vinculación</td>
                        <td class="input-cell">{{ deriv_uravit.es_vinculacion_uravit }}</td>
                        </tr>
                        <tr>
                        <td class="label-cell">Fecha respuesta</td>
                        <td class="input-cell">{{ deriv_uravit.fecha_respuesta_uravit }}</td>
                        </tr>
                    </table>
                    </td>
                </tr>

                <!-- CDM-CAI -->
                <tr>
                    <td class="label-cell">
                    <input type="checkbox"
                            name="deriv_cdm_cai-check"
                            id="deriv_cdm_cai_chk"
                            onchange="document.getElementById('deriv_cdm_cai_fields').style.display = this.checked ? '' : 'none';">
                    CDM-CAI
                    </td>
                    <td class="input-cell">
                    <table id="deriv_cdm_cai_fields" style="display:none; width:100%;">
                        <tr>
                        <td class="label-cell">Descripción</td>
                        <td class="input-cell">{{ deriv_cdm_cai.descripcion_cdm_cai }}</td>
                        </tr>
                        <tr>
                        <td class="label-cell">Fecha derivación</td>
                        <td class="input-cell">{{ deriv_cdm_cai.fecha_derivacion_cdm_cai }}</td>
                        </tr>
                        <tr>
                        <td class="label-cell">Es vinculación</td>
                        <td class="input-cell">{{ deriv_cdm_cai.es_vinculacion_cdm_cai }}</td>
                        </tr>
                        <tr>
                        <td class="label-cell">Fecha respuesta</td>
                        <td class="input-cell">{{ deriv_cdm_cai.fecha_respuesta_cdm_cai }}</td>
                        </tr>
                        <tr>
                        <td class="label-cell">Ingresa al programa</td>
                        <td class="input-cell">{{ deriv_cdm_cai.ingresa_cdm_cai }}</td>
                        </tr>
                        <tr>
                        <td class="label-cell">Fecha ingreso</td>
                        <td class="input-cell">{{ deriv_cdm_cai.fecha_ingreso_cdm_cai }}</td>
                        </tr>
                    </table>
                    </td>
                </tr>

                <!-- SALUD -->
                <tr>
                    <td class="label-cell">
                    <input type="checkbox"
                            name="deriv_salud-check"
                            id="deriv_salud_chk"
                            onchange="document.getElementById('deriv_salud_fields').style.display = this.checked ? '' : 'none';">
                    Salud
                    </td>
                    <td class="input-cell">
                    <table id="deriv_salud_fields" style="display:none; width:100%;">
                        <tr>
                        <td class="label-cell">Dispositivo de salud</td>
                        <td class="input-cell">{{ deriv_salud.dispositivo_salud }}</td>
                        </tr>
                        <tr id="row_salud_otro" style="display:none;">
                            <td class="label-cell">¿Cuál?</td>
                            <td class="input-cell">
                                <input type="text" name="deriv_salud-dispositivo_salud_otro" id="id_deriv_salud-dispositivo_salud_otro" maxlength="100">
                            </td>
                        </tr>
                        <tr>
                        <td class="label-cell">Fecha derivación</td>
                        <td class="input-cell">{{ deriv_salud.fecha_derivacion_salud }}</td>
                        </tr>
                        <tr>
                        <td class="label-cell">Es vinculación</td>
                        <td class="input-cell">{{ deriv_salud.es_vinculacion_salud }}</td>
                        </tr>
                        <tr>
                        <td class="label-cell">Fecha respuesta</td>
                        <td class="input-cell">{{ deriv_salud.fecha_respuesta_salud }}</td>
                        </tr>
                        <tr>
                        <td class="label-cell">Ingresa al dispositivo</td>
                        <td class="input-cell">{{ deriv_salud.ingresa_salud }}</td>
                        </tr>                       
                        <tr>
                        <td class="label-cell">Fecha ingreso</td>
                        <td class="input-cell">{{ deriv_salud.fecha_ingreso_salud }}</td>
                        </tr>
                    </table>
                    </td>
                </tr>

                <!-- OFAM -->
                <tr>
                    <td class="label-cell">
                    <input type="checkbox"
                            name="deriv_ofam-check"
                            id="deriv_ofam_chk"
                            onchange="document.getElementById('deriv_ofam_fields').style.display = this.checked ? '' : 'none';">
                    OFAM
                    </td>
                    <td class="input-cell">
                    <table id="deriv_ofam_fields" style="display:none; width:100%;">
                        <tr>
                        <td class="label-cell">Descripción</td>
                        <td class="input-cell">{{ deriv_ofam.descripcion_ofam }}</td>
                        </tr>
                        <tr>
                        <td class="label-cell">Fecha derivación</td>
                        <td class="input-cell">{{ deriv_ofam.fecha_derivacion_ofam }}</td>
                        </tr>
                        <tr>
                        <td class="label-cell">Es vinculación</td>
                        <td class="input-cell">{{ deriv_ofam.es_vinculacion_ofam }}</td>
                        </tr>
                        <tr>
                        <td class="label-cell">Fecha respuesta</td>
                        <td class="input-cell">{{ deriv_ofam.fecha_respuesta_ofam }}</td>
                        </tr>
                        <tr>
                        <td class="label-cell">Ingresa al programa</td>
                        <td class="input-cell">{{ deriv_ofam.ingresa_ofam }}</td>
                        </tr>
                        <tr>
                        <td class="label-cell">Fecha ingreso</td>
                        <td class="input-cell">{{ deriv_ofam.fecha_ingreso_ofam }}</td>
                        </tr>
                    </table>
                    </td>
                </tr>

                <!-- DIDECO -->
                <tr>
                    <td class="label-cell">
                    <input type="checkbox"
                            name="deriv_dideco-check"
                            id="deriv_dideco_chk"
                            onchange="document.getElementById('deriv_dideco_fields').style.display = this.checked ? '' : 'none';">
                    DIDECO
                    </td>
                    <td class="input-cell">
                    <table id="deriv_dideco_fields" style="display:none; width:100%;">
                        <tr>
                        <td class="label-cell">Descripción</td>
                        <td class="input-cell">{{ deriv_dideco.descripcion_dideco }}</td>
                        </tr>
                        <tr>
                        <td class="label-cell">Fecha derivación</td>
                        <td class="input-cell">{{ deriv_dideco.fecha_derivacion_dideco }}</td>
                        </tr>
                        <tr>
                        <td class="label-cell">Es vinculación</td>
                        <td class="input-cell">{{ deriv_dideco.es_vinculacion_dideco }}</td>
                        </tr>
                        <tr>
                        <td class="label-cell">Fecha respuesta</td>
                        <td class="input-cell">{{ deriv_dideco.fecha_respuesta_dideco }}</td>
                        </tr>
                        <tr>
                        <td class="label-cell">Ingresa al programa</td>
                        <td class="input-cell">{{ deriv_dideco.ingresa_dideco }}</td>
                        </tr>
                        <tr>
                        <td class="label-cell">Fecha ingreso</td>
                        <td class="input-cell">{{ deriv_dideco.fecha_ingreso_dideco }}</td>
                        </tr>
                    </table>
                    </td>
                </tr>

                <!-- Gestión Territorial -->
                <tr>
                    <td class="label-cell">
                    <input type="checkbox"
                            name="deriv_gestion_territorial-check"
                            id="deriv_gestion_chk"
                            onchange="document.getElementById('deriv_gestion_fields').style.display = this.checked ? '' : 'none';">
                    Gestión Territorial
                    </td>
                    <td class="input-cell">
                    <table id="deriv_gestion_fields" style="display:none; width:100%;">
                        <tr>
                        <td class="label-cell">Descripción</td>
                        <td class="input-cell">{{ deriv_gestion_territorial.descripcion_gestion_territorial }}</td>
                        </tr>
                        <tr>
                        <td class="label-cell">Fecha derivación</td>
                        <td class="input-cell">{{ deriv_gestion_territorial.fecha_derivacion_gestion_territorial }}</td>
                        </tr>
                        <tr>
                        <td class="label-cell">Es vinculación</td>
                        <td class="input-cell">{{ deriv_gestion_territorial.es_vinculacion_gestion_territorial }}</td>
                        </tr>
                        <tr>
                        <td class="label-cell">Fecha respuesta</td>
                        <td class="input-cell">{{ deriv_gestion_territorial.fecha_respuesta_gestion_territorial }}</td>
                        </tr>
                        <tr>
                        <td class="label-cell">Ingresa al programa</td>
                        <td class="input-cell">{{ deriv_gestion_territorial.ingresa_gestion_territorial }}</td>
                        </tr>
                        <tr>
                        <td class="label-cell">Fecha ingreso</td>
                        <td class="input-cell">{{ deriv_gestion_territorial.fecha_ingreso_gestion_territorial }}</td>
                        </tr>
                    </table>
                    </td>
                </tr>

                <!-- CAPS UDLA -->
                <tr>
                    <td class="label-cell">
                    <input type="checkbox"
                            name="deriv_caps_udla-check"
                            id="deriv_caps_chk"
                            onchange="document.getElementById('deriv_caps_fields').style.display = this.checked ? '' : 'none';">
                    CAPS UDLA
                    </td>
                    <td class="input-cell">
                    <table id="deriv_caps_fields" style="display:none; width:100%;">
                        <tr>
                        <td class="label-cell">Descripción</td>
                        <td class="input-cell">{{ deriv_caps_udla.descripcion_caps_udla }}</td>
                        </tr>
                        <tr>
                        <td class="label-cell">Fecha derivación</td>
                        <td class="input-cell">{{ deriv_caps_udla.fecha_derivacion_caps_udla }}</td>
                        </tr>
                        <tr>
                        <td class="label-cell">Es vinculación</td>
                        <td class="input-cell">{{ deriv_caps_udla.es_vinculacion_caps_udla }}</td>
                        </tr>
                        <tr>
                        <td class="label-cell">Fecha respuesta</td>
                        <td class="input-cell">{{ deriv_caps_udla.fecha_respuesta_caps_udla }}</td>
                        </tr>
                        <tr>
                        <td class="label-cell">Ingresa al programa</td>
                        <td class="input-cell">{{ deriv_caps_udla.ingresa_caps_udla }}</td>
                        </tr>
                        <tr>
                        <td class="label-cell">Fecha ingreso</td>
                        <td class="input-cell">{{ deriv_caps_udla.fecha_ingreso_caps_udla }}</td>
                        </tr>
                    </table>
                    </td>
                </tr>

                <!-- OLN -->
                <tr>
                    <td class="label-cell">
                    <input type="checkbox"
                            name="deriv_oln-check"
                            id="deriv_oln_chk"
                            onchange="document.getElementById('deriv_oln_fields').style.display = this.checked ? '' : 'none';">
                    OLN
                    </td>
                    <td class="input-cell">
                    <table id="deriv_oln_fields" style="display:none; width:100%;">
                        <tr>
                        <td class="label-cell">Descripción</td>
                        <td class="input-cell">{{ deriv_oln.descripcion_oln }}</td>
                        </tr>
                        <tr>
                        <td class="label-cell">Fecha derivación</td>
                        <td class="input-cell">{{ deriv_oln.fecha_derivacion_oln }}</td>
                        </tr>
                        <tr>
                        <td class="label-cell">Es vinculación</td>
                        <td class="input-cell">{{ deriv_oln.es_vinculacion_oln }}</td>
                        </tr>
                        <tr>
                        <td class="label-cell">Fecha respuesta</td>
                        <td class="input-cell">{{ deriv_oln.fecha_respuesta_oln }}</td>
                        </tr>
                        <tr>
                        <td class="label-cell">Ingresa al programa</td>
                        <td class="input-cell">{{ deriv_oln.ingresa_oln }}</td>
                        </tr>
                        <tr>
                        <td class="label-cell">Fecha ingreso</td>
                        <td class="input-cell">{{ deriv_oln.fecha_ingreso_oln }}</td>
                        </tr>
                    </table>
                    </td>
                </tr>

                <!-- OTRO -->
                <tr>
                    <td class="label-cell">
                    <input type="checkbox"
                            name="deriv_otro-check"
                            id="deriv_otro_chk"
                            onchange="document.getElementById('deriv_otro_fields').style.display = this.checked ? '' : 'none';">
                    Otro
                    </td>
                    <td class="input-cell">
                    <table id="deriv_otro_fields" style="display:none; width:100%;">
                        <tr>
                        <td class="label-cell">Institución (otro)</td>
                        <td class="input-cell">{{ deriv_otro.institucion_otro }}</td>
                        </tr>
                        <tr>
                        <td class="label-cell">Descripción</td>
                        <td class="input-cell">{{ deriv_otro.descripcion_otro }}</td>
                        </tr>
                        <tr>
                        <td class="label-cell">Fecha derivación</td>
                        <td class="input-cell">{{ deriv_otro.fecha_derivacion_otro }}</td>
                        </tr>
                        <tr>
                        <td class="label-cell">Es vinculación</td>
                        <td class="input-cell">{{ deriv_otro.es_vinculacion_otro }}</td>
                        </tr>
                        <tr>
                        <td class="label-cell">Fecha respuesta</td>
                        <td class="input-cell">{{ deriv_otro.fecha_respuesta_otro }}</td>
                        </tr>
                        <tr>
                        <td class="label-cell">Ingresa al programa</td>
                        <td class="input-cell">{{ deriv_otro.ingresa_otro }}</td>
                        </tr>
                        <tr>
                        <td class="label-cell">Fecha ingreso</td>
                        <td class="input-cell">{{ deriv_otro.fecha_ingreso_otro }}</td>
                        </tr>
                    </table>
                    </td>
                </tr>

                </tbody>
            </table>

            </div>
        </div>
        </div>
        <!-- FIN Acordeón Derivaciones -->




        </div><!-- /.accordion -->

        <div class="form-footer text-center mt-4">
        <button type="submit" class="btn btn-institucional btn-lg">
            Guardar Ficha
        </button>
        </div>
        </form>
        </div>


<script src="{% static 'fichas/js/ficha_completa.js' %}"></script>



{% endblock %}
