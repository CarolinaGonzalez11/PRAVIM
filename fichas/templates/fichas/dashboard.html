{% extends 'base.html' %}
{% load static %}
{% block content %}

<style>
/* Estilo principal de los filtros */
.busqueda-form {
    background: #f6f8fb;
    padding: 25px 30px;
    border-radius: 14px;
    margin-bottom: 32px;
    border: 2px solid #252c54;
    max-width: 1400px;
    margin-left: auto;
    margin-right: auto;
    box-shadow: 0 4px 12px rgba(37, 44, 84, 0.08);
}

.busqueda-form label {
    font-weight: 600;
    color: #252c54;
    font-size: 0.9rem;
    margin-bottom: 6px;
}

.busqueda-form input, 
.busqueda-form select {
    border: 1.5px solid #b8bbd8;
    border-radius: 6px;
    font-size: 0.95rem;
    padding: 8px 12px;
    width: 100%;
    transition: all 0.2s;
    background-color: #fff;
}

.busqueda-form input:focus, 
.busqueda-form select:focus {
    border-color: #252c54;
    box-shadow: 0 0 0 3px rgba(37, 44, 84, 0.15);
    outline: none;
}

.filtros-row {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    margin-bottom: 15px;
}

.filtro-group {
    flex: 1;
    min-width: 180px;
}

.botones-row {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 12px;
    padding-top: 8px;
    border-top: 1px solid #e0e3f2;
}

/* Botones principales */
.btn-institucional {
    background: #252c54;
    color: #fff !important;
    border: none;
    font-weight: bold;
    padding: 10px 28px;
    border-radius: 8px;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.btn-institucional:hover { 
    background: #1a2040; 
    transform: translateY(-1px);
}

.btn-reset {
    text-decoration: none !important;
    background: #e0e3f2;
    color: #252c54;
    font-weight: 600;
    border: 1.5px solid #c9cbe0;
    padding: 10px 24px;
    border-radius: 8px;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.btn-reset:hover {
    background: #d1d5e8;
    transform: translateY(-1px);
}

.btn-excel {
    background: #217346;
    color: #fff !important;
    font-weight: 700;
    border: none;
    padding: 10px 24px;
    border-radius: 8px;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.btn-excel:hover {
    background: #1a5c38;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(33, 115, 70, 0.3);
}

.btn-excel:disabled {
    background: #a0b8a9;
    color: #e0e0e0 !important;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

/* Estilo para el título del dashboard */
.dashboard-title {
    color: #252c54;
    font-weight: bold;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 2px solid #252c54;
}

/* Estilo para las tarjetas KPI */
.kpis-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.kpi-card {
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(37, 44, 84, 0.1);
    color: white;
    text-align: center;
    transition: transform 0.2s;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.kpi-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 16px rgba(37, 44, 84, 0.15);
}

.kpi-card:nth-child(1) {
    background-color: #e60380;
}

.kpi-card:not(:nth-child(1)) {
    background-color: #252c54;
}

.kpi-title {
    font-size: 0.95rem;
    font-weight: 600;
    margin-bottom: 10px;
    opacity: 0.9;
}

.kpi-value {
    font-size: 1.8rem;
    font-weight: 700;
    line-height: 1.2;
}

/* Estilo para las secciones */
.section-title {
    color: #252c54;
    font-weight: 600;
    margin: 30px 0 20px;
    padding-bottom: 12px;
    border-bottom: 2px solid #e0e3f2;
}

/* Estilo para las tarjetas de gráficos */
.graficos-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 24px;
    margin-bottom: 32px;
}

.grafico-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(37, 44, 84, 0.08);
    overflow: hidden;
    border: 1px solid #e0e3f2;
    transition: transform 0.2s, box-shadow 0.2s;
}

.grafico-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 16px rgba(37, 44, 84, 0.12);
}

.grafico-header {
    padding: 16px 20px;
    background: #f8f9fc;
    border-bottom: 1px solid #e0e3f2;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.grafico-header h4 {
    margin: 0;
    color: #252c54;
    font-size: 1.1rem;
    font-weight: 600;
}

.grafico-body {
    padding: 20px;
    min-height: 300px;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.sin-datos {
    color: #6c757d;
    text-align: center;
    padding: 20px 0;
}

/* Estilo para la tabla de derivaciones */
.derivaciones-table {
    width: 100%;
    max-width: 680px;
    border-collapse: separate;
    border-spacing: 0;
    background: white;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(37, 44, 84, 0.08);
}

.derivaciones-table th {
    background: #252c54;
    color: white;
    padding: 12px 16px;
    text-align: left;
    font-weight: 600;
}

.derivaciones-table td {
    padding: 10px 16px;
    border-bottom: 1px solid #f1f3f9;
}

.derivaciones-table tr:last-child td {
    border-bottom: none;
}

.derivaciones-table tr:hover td {
    background: #f8f9fc;
}

.total-row {
    font-weight: bold;
    background: #f6f6b8 !important;
}

.total-row td {
    border-top: 2px solid #e0e3f2;
}

/* Botón de pantalla completa */
.btn-fullscreen {
    background: #e60380;
    border: none;
    color: #fff;
    cursor: pointer;
    font-size: 1rem;
    padding: 6px 12px;
    border-radius: 6px;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
}

.btn-fullscreen:hover {
    background: #252c54;
    transform: translateY(-1px);
}

/* Modal para pantalla completa */
.fullscreen-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    z-index: 1000;
    justify-content: center;
    align-items: center;
}

.fullscreen-content {
    width: 90%;
    height: 85%;
    background: white;
    border-radius: 12px;
    padding: 20px;
    position: relative;
}

.fullscreen-close {
    position: absolute;
    top: 15px;
    right: 15px;
    background: #252c54;
    color: white;
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    font-size: 1.2rem;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: all 0.2s;
}

.fullscreen-close:hover {
    background: #e60380;
    transform: scale(1.1);
}

.fullscreen-chart-container {
    width: 100%;
    height: 100%;
}

/* Responsive */
@media (max-width: 768px) {
    .kpis-container {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    }
    
    .graficos-container {
        grid-template-columns: 1fr;
    }
    
    .fullscreen-content {
        width: 95%;
        height: 90%;
    }
}

@media (max-width: 480px) {
    .kpis-container {
        grid-template-columns: 1fr 1fr;
    }
    
    .kpi-value {
        font-size: 1.5rem;
    }
    
    .botones-row {
        flex-direction: column;
        align-items: stretch;
    }
    
    .btn-institucional, 
    .btn-reset, 
    .btn-excel {
        width: 100%;
        justify-content: center;
    }
}
.fullscreen-modal {
    /* ...tu código... */
    z-index: 2000 !important;
}
</style>

<div class="container my-4">
    <!-- Título principal -->
    <h2 class="dashboard-title">Dashboard Estadístico PRAVIM</h2>

    <!-- Filtros Avanzados con nuevo estilo -->
    <form method="get" class="busqueda-form" id="form-filtros-dashboard">
        <div class="filtros-row">
            <!-- Barrio -->
            <div class="filtro-group">
                <label for="barrio">Barrio</label>
                <select id="barrio" name="barrio">
                    <option value="">Todos</option>
                    {% for barrio in barrios %}
                        <option value="{{ barrio.id }}" {% if filtros.barrio == barrio.id|stringformat:"s" %}selected{% endif %}>{{ barrio.nombre }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Cuadrante -->
            <div class="filtro-group">
                <label for="cuadrante">Cuadrante</label>
                <select id="cuadrante" name="cuadrante">
                    <option value="">Todos</option>
                    {% for cuad in cuadrantes %}
                        <option value="{{ cuad.id }}" {% if filtros.cuadrante == cuad.id|stringformat:"s" %}selected{% endif %}>{{ cuad.nombre }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Género -->
            <div class="filtro-group">
                <label for="genero">Género</label>
                <select id="genero" name="genero">
                    <option value="">Todos</option>
                    {% for v, l in generos %}
                        <option value="{{ v }}" {% if filtros.genero == v %}selected{% endif %}>{{ l }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Motivo -->
            <div class="filtro-group">
                <label for="motivo_ingreso">Motivo</label>
                <select id="motivo_ingreso" name="motivo_ingreso">
                    <option value="">Todos</option>
                    {% for v, l in motivos %}
                        <option value="{{ v }}" {% if filtros.motivo == v %}selected{% endif %}>{{ l }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Profesional -->
            <div class="filtro-group">
                <label for="profesional">Profesional</label>
                <select id="profesional" name="profesional">
                    <option value="">Todos</option>
                    <option value="nathaly" {% if filtros.profesional == "nathaly" %}selected{% endif %}>Nathaly Reyes</option>
                    <option value="paloma" {% if filtros.profesional == "paloma" %}selected{% endif %}>Paloma Quinteros</option>
                    <option value="gloria" {% if filtros.profesional == "gloria" %}selected{% endif %}>Gloria Rivera</option>
                </select>
            </div>
            
            <!-- Estado -->
            <div class="filtro-group">
                <label for="estado">Estado</label>
                <select id="estado" name="estado">
                    <option value="">Todos</option>
                    {% for v, l in estados %}
                        <option value="{{ v }}" {% if filtros.estado == v %}selected{% endif %}>{{ l }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Etapa -->
            <div class="filtro-group">
                <label for="etapa">Etapa</label>
                <select id="etapa" name="etapa">
                    <option value="">Todas</option>
                    {% for v, l in etapas %}
                        <option value="{{ v }}" {% if filtros.etapa == v %}selected{% endif %}>{{ l }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Fechas -->
            <div class="filtro-group">
                <label for="fecha_inicio">Desde</label>
                <input type="date" name="fecha_inicio" value="{{ filtros.fecha_inicio|default_if_none:'' }}">
            </div>
            
            <div class="filtro-group">
                <label for="fecha_fin">Hasta</label>
                <input type="date" name="fecha_fin" value="{{ filtros.fecha_fin|default_if_none:'' }}">
            </div>
        </div>
        
        <div class="botones-row">
            <button type="submit" class="btn-institucional">
                <i class="bi bi-funnel"></i> Filtrar
            </button>
            <a href="{% url 'fichas:dashboard' %}" class="btn-reset">
                <i class="bi bi-arrow-counterclockwise"></i> Limpiar
            </a>
            <button type="button" class="btn-excel" id="btn-excel-dashboard">
                <i class="bi bi-file-earmark-excel"></i> Exportar
            </button>
        </div>
    </form>

    <!-- KPIs -->
    <div class="kpis-container">
        <div class="kpi-card" style="background-color: #e60380 ;">
            <div class="kpi-title">Total Fichas</div>
            <div class="kpi-value">{{ total_fichas|default:"0" }}</div>
        </div>
        
        <div class="kpi-card" style="background-color: #252c54;">
            <div class="kpi-title">Preingresos</div>
            <div class="kpi-value">{{ total_preingresos|default:"0" }}</div>
        </div>
        
        <div class="kpi-card" style="background-color: #252c54;">
            <div class="kpi-title">Ingresos efectivos</div>
            <div class="kpi-value">{{ total_ingresos|default:"0" }}</div>
        </div>
        
        <div class="kpi-card" style="background-color: #252c54;">
            <div class="kpi-title">% Ingreso Efectivo</div>
            <div class="kpi-value">{{ porcentaje_ingreso_efectivo|default:"0" }}%</div>
        </div>
        
        <div class="kpi-card" style="background-color: #252c54;">
            <div class="kpi-title">Egresos</div>
            <div class="kpi-value">{{ total_egresos|default:"0" }}</div>
        </div>
        
        <div class="kpi-card" style="background-color: #252c54;">
            <div class="kpi-title">Intervenciones</div>
            <div class="kpi-value">{{ total_intervenciones|default:"0" }}</div>
        </div>
        
        <div class="kpi-card" style="background-color: #252c54;">
            <div class="kpi-title">Total Derivaciones</div>
            <div class="kpi-value">{{ total_derivaciones|default:"0" }}</div>
        </div>
    </div>

    <!-- Gráficos Principales -->
    <div class="graficos-container">
        <!-- Motivo de Ingreso -->
        <div class="grafico-card">
            <div class="grafico-header">
                <h4>Motivo de Ingreso</h4>
                <button class="btn-fullscreen" onclick="openFullscreen('motivoChart')" title="Expandir gráfico">
                    <i class="bi bi-arrows-fullscreen"></i>
                </button>

            </div>
            <div class="grafico-body">
                {% if motivo_data %}
                <canvas id="motivoChart"></canvas>
                {% else %}
                <div class="sin-datos">No hay datos para mostrar.</div>
                {% endif %}
            </div>
        </div>
        
        <!-- Género -->
        <div class="grafico-card">
            <div class="grafico-header">
                <h4>Género</h4>
                <button class="btn-fullscreen" onclick="openFullscreen('generoChart')" title="Expandir gráfico">
                    <i class="bi bi-arrows-fullscreen"></i>
                </button>
            </div>
            <div class="grafico-body">
                {% if genero_data %}
                <canvas id="generoChart"></canvas>
                {% else %}
                <div class="sin-datos">No hay datos para mostrar.</div>
                {% endif %}
            </div>
        </div>
        
        <!-- Rango Etáreo -->
        <div class="grafico-card">
            <div class="grafico-header">
                <h4>Rango Etáreo</h4>
                <button class="btn-fullscreen" onclick="openFullscreen('rangoChart')" title="Expandir gráfico">
                    <i class="bi bi-arrows-fullscreen"></i>
                </button>
            </div>
            <div class="grafico-body">
                {% if rango_data %}
                <canvas id="rangoChart"></canvas>
                {% else %}
                <div class="sin-datos">No hay datos para mostrar.</div>
                {% endif %}
            </div>
        </div>
        
        <!-- Previsión -->
        <div class="grafico-card">
            <div class="grafico-header">
                <h4>Previsión</h4>
                <button class="btn-fullscreen" onclick="openFullscreen('previsionChart')" title="Expandir gráfico">
                    <i class="bi bi-arrows-fullscreen"></i>
                </button>
            </div>
            <div class="grafico-body">
                {% if prevision_data %}
                <canvas id="previsionChart"></canvas>
                {% else %}
                <div class="sin-datos">No hay datos para mostrar.</div>
                {% endif %}
            </div>
        </div>
        
        <!-- Nacionalidad -->
        <div class="grafico-card">
            <div class="grafico-header">
                <h4>Nacionalidad</h4>
                <button class="btn-fullscreen" onclick="openFullscreen('nacionalidadChart')" title="Expandir gráfico">
                    <i class="bi bi-arrows-fullscreen"></i>
                </button>
            </div>
            <div class="grafico-body">
                {% if nacionalidad_data %}
                <canvas id="nacionalidadChart"></canvas>
                {% else %}
                <div class="sin-datos">No hay datos para mostrar.</div>
                {% endif %}
            </div>
        </div>
        
        <!-- Barrio -->
        <div class="grafico-card">
            <div class="grafico-header">
                <h4>Barrio</h4>
                <button class="btn-fullscreen" onclick="openFullscreen('barrioChart')" title="Expandir gráfico">
                    <i class="bi bi-arrows-fullscreen"></i>
                </button>
            </div>
            <div class="grafico-body">
                {% if barrio_data %}
                <canvas id="barrioChart"></canvas>
                {% else %}
                <div class="sin-datos">No hay datos para mostrar.</div>
                {% endif %}
            </div>
        </div>
        
        <!-- Cuadrante -->
        <div class="grafico-card">
            <div class="grafico-header">
                <h4>Cuadrante</h4>
                <button class="btn-fullscreen" onclick="openFullscreen('cuadranteChart')" title="Expandir gráfico">
                    <i class="bi bi-arrows-fullscreen"></i>
                </button>
            </div>
            <div class="grafico-body">
                {% if cuadrante_data %}
                <canvas id="cuadranteChart"></canvas>
                {% else %}
                <div class="sin-datos">No hay datos para mostrar.</div>
                {% endif %}
            </div>
        </div>
        
        <!-- Profesional -->
        <div class="grafico-card">
            <div class="grafico-header">
                <h4>Profesional a cargo</h4>
                <button class="btn-fullscreen" onclick="openFullscreen('profesionalChart')" title="Expandir gráfico">
                    <i class="bi bi-arrows-fullscreen"></i>
                </button>
            </div>
            <div class="grafico-body">
                {% if profesional_data %}
                <canvas id="profesionalChart"></canvas>
                {% else %}
                <div class="sin-datos">No hay datos para mostrar.</div>
                {% endif %}
            </div>
        </div>
        
        <!-- Diagnóstico -->
        <div class="grafico-card">
            <div class="grafico-header">
                <h4>Diagnóstico Salud Mental</h4>
                <button class="btn-fullscreen" onclick="openFullscreen('diagnosticoChart')" title="Expandir gráfico">
                    <i class="bi bi-arrows-fullscreen"></i>
                </button>
            </div>
            <div class="grafico-body">
                {% if diagnostico_data %}
                <canvas id="diagnosticoChart"></canvas>
                {% else %}
                <div class="sin-datos">No hay datos para mostrar.</div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Gráficos Temporales -->
    <div class="graficos-container">
        <!-- Fichas por mes -->
        <div class="grafico-card">
            <div class="grafico-header">
                <h4>Fichas ingresadas por mes</h4>
                <button class="btn-fullscreen" onclick="openFullscreen('fichasMesChart')" title="Expandir gráfico">
                    <i class="bi bi-arrows-fullscreen"></i>
                </button>
            </div>
            <div class="grafico-body">
                {% if fichas_mes_data %}
                <canvas id="fichasMesChart"></canvas>
                {% else %}
                <div class="sin-datos">No hay datos para mostrar.</div>
                {% endif %}
            </div>
        </div>
        
        <!-- Egresos por mes -->
        <div class="grafico-card">
            <div class="grafico-header">
                <h4>Egresos por mes</h4>
                <button class="btn-fullscreen" onclick="openFullscreen('egresosMesChart')" title="Expandir gráfico">
                    <i class="bi bi-arrows-fullscreen"></i>
                </button>
            </div>
            <div class="grafico-body">
                {% if egresos_mes_data %}
                <canvas id="egresosMesChart"></canvas>
                {% else %}
                <div class="sin-datos">No hay datos para mostrar.</div>
                {% endif %}
            </div>
        </div>
        
        <!-- Intervenciones por mes -->
        <div class="grafico-card">
            <div class="grafico-header">
                <h4>Intervenciones por mes</h4>
                <button class="btn-fullscreen" onclick="openFullscreen('intervencionesMesChart')" title="Expandir gráfico">
                    <i class="bi bi-arrows-fullscreen"></i>
                </button>
            </div>
            <div class="grafico-body">
                {% if intervenciones_mes_data %}
                <canvas id="intervencionesMesChart"></canvas>
                {% else %}
                <div class="sin-datos">No hay datos para mostrar.</div>
                {% endif %}
            </div>
        </div>
    </div>


    <h4 class="section-title">Detalle de Derivaciones</h4>
    <div class="table-responsive">
        <table class="derivaciones-table">
            <thead>
            <tr style="background:#252c54; color:white;">
            <th style="padding:8px;">Tipo de Derivación</th>
            <th style="padding:8px;">Total</th>
            </tr>
        </thead>
        <tbody>
            <tr><td>Salud</td><td>{{ derivaciones.salud }}</td></tr>
            <tr><td>CAVD</td><td>{{ derivaciones.cavd }}</td></tr>
            <tr><td>OFAM</td><td>{{ derivaciones.ofam }}</td></tr>
            <tr><td>URAVIT</td><td>{{ derivaciones.uravit }}</td></tr>
            <tr><td>DIDECO</td><td>{{ derivaciones.dideco }}</td></tr>
            <tr><td>Gestión Territorial</td><td>{{ derivaciones.gestion_territorial }}</td></tr>
            <tr><td>CAPS UDLA</td><td>{{ derivaciones.caps_udla }}</td></tr>
            <tr><td>OLN</td><td>{{ derivaciones.oln }}</td></tr>
            <tr><td>CDM-CAI</td><td>{{ derivaciones.cdm_cai }}</td></tr>
            <tr><td>Otro</td><td>{{ derivaciones.otro }}</td></tr>
            <tr style="font-weight:bold;background:#f6f6b8;">
            <td style="text-align:right;">Total Derivaciones</td>
            <td>{{ total_derivaciones|default:"0" }}</td>
            </tr>
        </tbody>
        </table>
    </div>
</div>

<!-- Modal para gráficos en pantalla completa -->
<div id="fullscreenModal" class="fullscreen-modal">
    <button class="fullscreen-close" onclick="closeFullscreen()">
        <i class="bi bi-x-lg"></i>
    </button>
    <div class="fullscreen-content">
        <div class="fullscreen-chart-container">
            <canvas id="fullscreenChart"></canvas>
        </div>
    </div>
</div>

<!-- Pasar datos de context a JS -->
{{ motivo_labels|json_script:"motivo-labels" }} {{ motivo_data|json_script:"motivo-data" }}
{{ genero_labels|json_script:"genero-labels" }} {{ genero_data|json_script:"genero-data" }}
{{ rango_labels|json_script:"rango-labels" }} {{ rango_data|json_script:"rango-data" }}
{{ nacionalidad_labels|json_script:"nacionalidad-labels" }} {{ nacionalidad_data|json_script:"nacionalidad-data" }}
{{ prevision_labels|json_script:"prevision-labels" }} {{ prevision_data|json_script:"prevision-data" }}
{{ barrio_labels|json_script:"barrio-labels" }} {{ barrio_data|json_script:"barrio-data" }}
{{ cuadrante_labels|json_script:"cuadrante-labels" }} {{ cuadrante_data|json_script:"cuadrante-data" }}
{{ profesional_labels|json_script:"profesional-labels" }} {{ profesional_data|json_script:"profesional-data" }}
{{ diagnostico_labels|json_script:"diagnostico-labels" }} {{ diagnostico_data|json_script:"diagnostico-data" }}
{{ fichas_mes_labels|json_script:"fichas-mes-labels" }} {{ fichas_mes_data|json_script:"fichas-mes-data" }}
{{ egresos_mes_labels|json_script:"egresos-mes-labels" }} {{ egresos_mes_data|json_script:"egresos-mes-data" }}
{{ intervenciones_mes_labels|json_script:"intervenciones-mes-labels" }} {{ intervenciones_mes_data|json_script:"intervenciones-mes-data" }}

<!-- Chart.js y plugins -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
<script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>

<script>
// Paleta para tortas/pie
const PIE_COLORS = [
    "#e60380", "#252c54", "#31ccec", "#ffb71b", "#8a2be2", "#00b894",
    "#ff7675", "#fab1a0", "#636e72", "#ffeaa7", "#00b894", "#fdcb6e"
];

// Utilidad para oscurecer color
function shadeColor(color, percent) {
    let R = parseInt(color.substring(1,3), 16);
    let G = parseInt(color.substring(3,5), 16);
    let B = parseInt(color.substring(5,7), 16);
    R = parseInt(R * (100 + percent) / 100);
    G = parseInt(G * (100 + percent) / 100);
    B = parseInt(B * (100 + percent) / 100);
    R = (R<255)?R:255; G = (G<255)?G:255; B = (B<255)?B:255;
    R = Math.round(R); G = Math.round(G); B = Math.round(B);
    const RR = ((R.toString(16).length==1)?"0"+R.toString(16):R.toString(16));
    const GG = ((G.toString(16).length==1)?"0"+G.toString(16):G.toString(16));
    const BB = ((B.toString(16).length==1)?"0"+B.toString(16):B.toString(16));
    return "#"+RR+GG+BB;
}

// Objeto para almacenar las configuraciones limpias de cada gráfico
const chartDataOriginal = {
    motivoChart: {
        type: 'bar',
        data: {
            labels: JSON.parse(document.getElementById('motivo-labels').textContent),
            datasets: [{
                label: "Motivo de Ingreso",
                data: JSON.parse(document.getElementById('motivo-data').textContent),
                backgroundColor: JSON.parse(document.getElementById('motivo-labels').textContent).map(() => '#252c54'),
                borderColor: JSON.parse(document.getElementById('motivo-labels').textContent).map(() => shadeColor('#252c54', -20)),
                borderWidth: 1
            }]
        },
        options: {}
    },
    generoChart: {
        type: 'pie',
        data: {
            labels: JSON.parse(document.getElementById('genero-labels').textContent),
            datasets: [{
                label: "Género",
                data: JSON.parse(document.getElementById('genero-data').textContent),
                backgroundColor: JSON.parse(document.getElementById('genero-labels').textContent).map((_, i) => PIE_COLORS[i % PIE_COLORS.length]),
                borderColor: "#fff",
                borderWidth: 1
            }]
        },
        options: {}
    },
    rangoChart: {
        type: 'bar',
        data: {
            labels: JSON.parse(document.getElementById('rango-labels').textContent),
            datasets: [{
                label: "Rango Etáreo",
                data: JSON.parse(document.getElementById('rango-data').textContent),
                backgroundColor: JSON.parse(document.getElementById('rango-labels').textContent).map(() => '#252c54'),
                borderColor: JSON.parse(document.getElementById('rango-labels').textContent).map(() => shadeColor('#252c54', -20)),
                borderWidth: 1
            }]
        },
        options: {}
    },
    previsionChart: {
        type: 'bar',
        data: {
            labels: JSON.parse(document.getElementById('prevision-labels').textContent),
            datasets: [{
                label: "Previsión",
                data: JSON.parse(document.getElementById('prevision-data').textContent),
                backgroundColor: JSON.parse(document.getElementById('prevision-labels').textContent).map(() => '#252c54'),
                borderColor: JSON.parse(document.getElementById('prevision-labels').textContent).map(() => shadeColor('#252c54', -20)),
                borderWidth: 1
            }]
        },
        options: {}
    },
    nacionalidadChart: {
        type: 'bar',
        data: {
            labels: JSON.parse(document.getElementById('nacionalidad-labels').textContent),
            datasets: [{
                label: "Nacionalidad",
                data: JSON.parse(document.getElementById('nacionalidad-data').textContent),
                backgroundColor: JSON.parse(document.getElementById('nacionalidad-labels').textContent).map(() => '#252c54'),
                borderColor: JSON.parse(document.getElementById('nacionalidad-labels').textContent).map(() => shadeColor('#252c54', -20)),
                borderWidth: 1
            }]
        },
        options: {}
    },
    barrioChart: {
        type: 'bar',
        data: {
            labels: JSON.parse(document.getElementById('barrio-labels').textContent),
            datasets: [{
                label: "Barrio",
                data: JSON.parse(document.getElementById('barrio-data').textContent),
                backgroundColor: JSON.parse(document.getElementById('barrio-labels').textContent).map(() => '#252c54'),
                borderColor: JSON.parse(document.getElementById('barrio-labels').textContent).map(() => shadeColor('#252c54', -20)),
                borderWidth: 1
            }]
        },
        options: {}
    },
    cuadranteChart: {
        type: 'bar',
        data: {
            labels: JSON.parse(document.getElementById('cuadrante-labels').textContent),
            datasets: [{
                label: "Cuadrante",
                data: JSON.parse(document.getElementById('cuadrante-data').textContent),
                backgroundColor: JSON.parse(document.getElementById('cuadrante-labels').textContent).map(() => '#252c54'),
                borderColor: JSON.parse(document.getElementById('cuadrante-labels').textContent).map(() => shadeColor('#252c54', -20)),
                borderWidth: 1
            }]
        },
        options: {}
    },
    profesionalChart: {
        type: 'bar',
        data: {
            labels: JSON.parse(document.getElementById('profesional-labels').textContent),
            datasets: [{
                label: "Profesional",
                data: JSON.parse(document.getElementById('profesional-data').textContent),
                backgroundColor: JSON.parse(document.getElementById('profesional-labels').textContent).map(() => '#252c54'),
                borderColor: JSON.parse(document.getElementById('profesional-labels').textContent).map(() => shadeColor('#252c54', -20)),
                borderWidth: 1
            }]
        },
        options: {}
    },
    diagnosticoChart: {
        type: 'bar',
        data: {
            labels: JSON.parse(document.getElementById('diagnostico-labels').textContent),
            datasets: [{
                label: "Diagnóstico Salud Mental",
                data: JSON.parse(document.getElementById('diagnostico-data').textContent),
                backgroundColor: JSON.parse(document.getElementById('diagnostico-labels').textContent).map(() => '#252c54'),
                borderColor: JSON.parse(document.getElementById('diagnostico-labels').textContent).map(() => shadeColor('#252c54', -20)),
                borderWidth: 1
            }]
        },
        options: {}
    },
    fichasMesChart: {
        type: 'line',
        data: {
            labels: JSON.parse(document.getElementById('fichas-mes-labels').textContent),
            datasets: [{
                label: "Fichas por Mes",
                data: JSON.parse(document.getElementById('fichas-mes-data').textContent),
                borderColor: '#252c54',
                backgroundColor: '#252c54',
                fill: false,
                tension: 0.25,
                pointBackgroundColor: '#252c54',
                pointBorderColor: '#252c54',
                pointRadius: 4,
            }]
        },
        options: {}
    },
    egresosMesChart: {
        type: 'line',
        data: {
            labels: JSON.parse(document.getElementById('egresos-mes-labels').textContent),
            datasets: [{
                label: "Egresos por Mes",
                data: JSON.parse(document.getElementById('egresos-mes-data').textContent),
                borderColor: '#252c54',
                backgroundColor: '#252c54',
                fill: false,
                tension: 0.25,
                pointBackgroundColor: '#252c54',
                pointBorderColor: '#252c54',
                pointRadius: 4,
            }]
        },
        options: {}
    },
    intervencionesMesChart: {
        type: 'line',
        data: {
            labels: JSON.parse(document.getElementById('intervenciones-mes-labels').textContent),
            datasets: [{
                label: "Intervenciones por Mes",
                data: JSON.parse(document.getElementById('intervenciones-mes-data').textContent),
                borderColor: '#252c54',
                backgroundColor: '#252c54',
                fill: false,
                tension: 0.25,
                pointBackgroundColor: '#252c54',
                pointBorderColor: '#252c54',
                pointRadius: 4,
            }]
        },
        options: {}
    },
};

// Configuración de opciones para cada tipo
function getBarOptions(isLarge) {
    return {
        indexAxis: isLarge ? 'y' : 'x',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false },
            datalabels: {
                anchor: isLarge ? 'end' : 'center',
                align: isLarge ? 'right' : 'center',
                color: '#252c54',
                font: { weight: 'bold', size: isLarge ? 10 : 12 },
                formatter: value => value,
                display: true
            },
            zoom: {
                zoom: { wheel: {enabled: true}, pinch: {enabled: true}, mode: 'xy' },
                pan: { enabled: true, mode: 'xy' }
            }
        },
        scales: {
            x: { beginAtZero: true, grid: { color: 'rgba(0, 0, 0, 0.05)' } },
            y: { grid: { display: false } }
        }
    };
}
const pieOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
        datalabels: {
            color: '#fff',
            font: { weight: 'bold', size: 12 },
            formatter: function(value, ctx) {
                let total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                let pct = total > 0 ? Math.round((value / total) * 100) : 0;
                return value + ' (' + pct + '%)';
            },
            display: true
        },
        legend: {
            position: 'right',
            labels: { padding: 20, usePointStyle: true, pointStyle: 'circle', font: { size: 12 } }
        }
    }
};
function getLineOptions() {
    return {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false },
            datalabels: {
                color: '#252c54',
                anchor: 'end',
                align: 'top',
                font: { weight: 'bold', size: 12 },
                formatter: value => value,
                display: true
            },
            zoom: {
                zoom: { wheel: {enabled: true}, pinch: {enabled: true}, mode: 'x' },
                pan: { enabled: true, mode: 'x' }
            }
        },
        scales: {
            x: { ticks: { color: '#252c54', font: { weight: "bold", size: 12 } } },
            y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.07)' }, ticks: { color: '#252c54', font: { weight: "bold", size: 12 } } }
        }
    };
}

// Objeto para las instancias de gráficos
const charts = {};
let fullscreenChart = null;
let currentChartId = null;

// Inicialización
document.addEventListener("DOMContentLoaded", function() {
    // BarCharts
    let motivoLabels = chartDataOriginal.motivoChart.data.labels;
    charts.motivoChart = new Chart(document.getElementById("motivoChart").getContext('2d'), {
        type: 'bar',
        data: chartDataOriginal.motivoChart.data,
        options: getBarOptions(motivoLabels.length > 8),
        plugins: [ChartDataLabels]
    });
    charts.rangoChart = new Chart(document.getElementById("rangoChart").getContext('2d'), {
        type: 'bar',
        data: chartDataOriginal.rangoChart.data,
        options: getBarOptions(false),
        plugins: [ChartDataLabels]
    });
    charts.previsionChart = new Chart(document.getElementById("previsionChart").getContext('2d'), {
        type: 'bar',
        data: chartDataOriginal.previsionChart.data,
        options: getBarOptions(false),
        plugins: [ChartDataLabels]
    });
    charts.nacionalidadChart = new Chart(document.getElementById("nacionalidadChart").getContext('2d'), {
        type: 'bar',
        data: chartDataOriginal.nacionalidadChart.data,
        options: getBarOptions(false),
        plugins: [ChartDataLabels]
    });
    charts.barrioChart = new Chart(document.getElementById("barrioChart").getContext('2d'), {
        type: 'bar',
        data: chartDataOriginal.barrioChart.data,
        options: getBarOptions(false),
        plugins: [ChartDataLabels]
    });
    charts.cuadranteChart = new Chart(document.getElementById("cuadranteChart").getContext('2d'), {
        type: 'bar',
        data: chartDataOriginal.cuadranteChart.data,
        options: getBarOptions(false),
        plugins: [ChartDataLabels]
    });
    const profesionalCanvas = document.getElementById("profesionalChart");
    if (profesionalCanvas) {
        charts.profesionalChart = new Chart(profesionalCanvas.getContext('2d'), {
            type: 'bar',
            data: chartDataOriginal.profesionalChart.data,
            options: getBarOptions(false),
            plugins: [ChartDataLabels]
        });
    }

    charts.diagnosticoChart = new Chart(document.getElementById("diagnosticoChart").getContext('2d'), {
        type: 'bar',
        data: chartDataOriginal.diagnosticoChart.data,
        options: getBarOptions(false),
        plugins: [ChartDataLabels]
    });
    // Pie
    charts.generoChart = new Chart(document.getElementById("generoChart").getContext('2d'), {
        type: 'pie',
        data: chartDataOriginal.generoChart.data,
        options: pieOptions,
        plugins: [ChartDataLabels]
    });
    // Líneas
    charts.fichasMesChart = new Chart(document.getElementById("fichasMesChart").getContext('2d'), {
        type: 'line',
        data: chartDataOriginal.fichasMesChart.data,
        options: getLineOptions(),
        plugins: [ChartDataLabels]
    });
    charts.egresosMesChart = new Chart(document.getElementById("egresosMesChart").getContext('2d'), {
        type: 'line',
        data: chartDataOriginal.egresosMesChart.data,
        options: getLineOptions(),
        plugins: [ChartDataLabels]
    });
    charts.intervencionesMesChart = new Chart(document.getElementById("intervencionesMesChart").getContext('2d'), {
        type: 'line',
        data: chartDataOriginal.intervencionesMesChart.data,
        options: getLineOptions(),
        plugins: [ChartDataLabels]
    });
});

// ----------- PANTALLA COMPLETA SIN REFERENCIAS CHART.JS -----------
function openFullscreen(chartId) {
    const modal = document.getElementById('fullscreenModal');
    const fullscreenCanvas = document.getElementById('fullscreenChart');

    if (fullscreenChart) {
        fullscreenChart.destroy();
        fullscreenChart = null;
    }
    fullscreenCanvas.getContext('2d').clearRect(0, 0, fullscreenCanvas.width, fullscreenCanvas.height);
    fullscreenCanvas.width = fullscreenCanvas.parentElement.offsetWidth - 40;
    fullscreenCanvas.height = fullscreenCanvas.parentElement.offsetHeight - 40;

    let config = chartDataOriginal[chartId];
    if (!config) {
        alert("No se puede mostrar este gráfico en pantalla completa");
        return;
    }
    let configFull = JSON.parse(JSON.stringify(config)); // Clona solo datos limpios

    // Ajusta fuentes y detalles visuales para fullscreen
    if (configFull.options && configFull.options.plugins && configFull.options.plugins.datalabels) {
        configFull.options.plugins.datalabels.font = { weight: 'bold', size: 18 };
    }
    configFull.options = configFull.options || {};
    configFull.options.responsive = true;
    configFull.options.maintainAspectRatio = false;

    // Corrige tipo de opciones según tipo
    if (configFull.type === "bar") {
        let isLarge = (configFull.data.labels.length > 8 && chartId === "motivoChart");
        configFull.options = getBarOptions(isLarge);
        configFull.options.responsive = true;
        configFull.options.maintainAspectRatio = false;
        if (isLarge) configFull.options.plugins.datalabels.font.size = 16;
    }
    if (configFull.type === "pie") {
        configFull.options = pieOptions;
        configFull.options.responsive = true;
        configFull.options.maintainAspectRatio = false;
        configFull.options.plugins.datalabels.font.size = 16;
    }
    if (configFull.type === "line") {
        configFull.options = getLineOptions();
        configFull.options.responsive = true;
        configFull.options.maintainAspectRatio = false;
        configFull.options.plugins.datalabels.font.size = 16;
    }

    fullscreenChart = new Chart(fullscreenCanvas.getContext('2d'), {
        type: configFull.type,
        data: configFull.data,
        options: configFull.options,
        plugins: [ChartDataLabels]
    });

    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
}
function closeFullscreen() {
    const modal = document.getElementById('fullscreenModal');
    if (fullscreenChart) {
        fullscreenChart.destroy();
        fullscreenChart = null;
    }
    currentChartId = null;
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
}
document.getElementById('fullscreenModal').addEventListener('click', function(e) {
    if (e.target === this) closeFullscreen();
});
document.querySelector('.fullscreen-close').addEventListener('click', closeFullscreen);

document.addEventListener("DOMContentLoaded", function() {
    // BarCharts
    let motivoCanvas = document.getElementById("motivoChart");
    if (motivoCanvas) {
        charts.motivoChart = new Chart(motivoCanvas.getContext('2d'), {
            type: 'bar',
            data: chartDataOriginal.motivoChart.data,
            options: getBarOptions(chartDataOriginal.motivoChart.data.labels.length > 8),
            plugins: [ChartDataLabels]
        });
    }

    let rangoCanvas = document.getElementById("rangoChart");
    if (rangoCanvas) {
        charts.rangoChart = new Chart(rangoCanvas.getContext('2d'), {
            type: 'bar',
            data: chartDataOriginal.rangoChart.data,
            options: getBarOptions(false),
            plugins: [ChartDataLabels]
        });
    }

    let previsionCanvas = document.getElementById("previsionChart");
    if (previsionCanvas) {
        charts.previsionChart = new Chart(previsionCanvas.getContext('2d'), {
            type: 'bar',
            data: chartDataOriginal.previsionChart.data,
            options: getBarOptions(false),
            plugins: [ChartDataLabels]
        });
    }

    let nacionalidadCanvas = document.getElementById("nacionalidadChart");
    if (nacionalidadCanvas) {
        charts.nacionalidadChart = new Chart(nacionalidadCanvas.getContext('2d'), {
            type: 'bar',
            data: chartDataOriginal.nacionalidadChart.data,
            options: getBarOptions(false),
            plugins: [ChartDataLabels]
        });
    }

    let barrioCanvas = document.getElementById("barrioChart");
    if (barrioCanvas) {
        charts.barrioChart = new Chart(barrioCanvas.getContext('2d'), {
            type: 'bar',
            data: chartDataOriginal.barrioChart.data,
            options: getBarOptions(false),
            plugins: [ChartDataLabels]
        });
    }

    let cuadranteCanvas = document.getElementById("cuadranteChart");
    if (cuadranteCanvas) {
        charts.cuadranteChart = new Chart(cuadranteCanvas.getContext('2d'), {
            type: 'bar',
            data: chartDataOriginal.cuadranteChart.data,
            options: getBarOptions(false),
            plugins: [ChartDataLabels]
        });
    }

    let profesionalCanvas = document.getElementById("profesionalChart");
    if (profesionalCanvas) {
        charts.profesionalChart = new Chart(profesionalCanvas.getContext('2d'), {
            type: 'bar',
            data: chartDataOriginal.profesionalChart.data,
            options: getBarOptions(false),
            plugins: [ChartDataLabels]
        });
    }

    let diagnosticoCanvas = document.getElementById("diagnosticoChart");
    if (diagnosticoCanvas) {
        charts.diagnosticoChart = new Chart(diagnosticoCanvas.getContext('2d'), {
            type: 'bar',
            data: chartDataOriginal.diagnosticoChart.data,
            options: getBarOptions(false),
            plugins: [ChartDataLabels]
        });
    }

    // Pie
    let generoCanvas = document.getElementById("generoChart");
    if (generoCanvas) {
        charts.generoChart = new Chart(generoCanvas.getContext('2d'), {
            type: 'pie',
            data: chartDataOriginal.generoChart.data,
            options: pieOptions,
            plugins: [ChartDataLabels]
        });
    }

    // Líneas
    let fichasMesCanvas = document.getElementById("fichasMesChart");
    if (fichasMesCanvas) {
        charts.fichasMesChart = new Chart(fichasMesCanvas.getContext('2d'), {
            type: 'line',
            data: chartDataOriginal.fichasMesChart.data,
            options: getLineOptions(),
            plugins: [ChartDataLabels]
        });
    }

    let egresosMesCanvas = document.getElementById("egresosMesChart");
    if (egresosMesCanvas) {
        charts.egresosMesChart = new Chart(egresosMesCanvas.getContext('2d'), {
            type: 'line',
            data: chartDataOriginal.egresosMesChart.data,
            options: getLineOptions(),
            plugins: [ChartDataLabels]
        });
    }

    let intervencionesMesCanvas = document.getElementById("intervencionesMesChart");
    if (intervencionesMesCanvas) {
        charts.intervencionesMesChart = new Chart(intervencionesMesCanvas.getContext('2d'), {
            type: 'line',
            data: chartDataOriginal.intervencionesMesChart.data,
            options: getLineOptions(),
            plugins: [ChartDataLabels]
        });
    }
});


</script>
{% endblock %}
